# RiverWare_Ruleset 9.1.2 Patch
# Created 15:30 December 14, 2023
# 
RULESET
NAME "RBS Ruleset (from MRM run)";
AGENDA_ORDER ASCENDING;
DESCRIPTION "The way the spike and TBF overage rules are written, the EOWYST is reached at some point between Sept 1 and Sept 30. In low hydrologic years, the EOWYST will be reached slightly earlier in that month.     ";
PRECISION   2;
NOTES "";
BEGIN

  POLICY_GROUP   "3 Cycle- Limits and Checks";
  DESCRIPTION    "Cycle limits for safe channel capacity, USACE storage limits, etc.  If the reservoir goes into a shortage, it is recorded here by way of the Shortage object. If that comes into play you must run Cycle 4.";
  ACTIVE         TRUE;
  NAMES_COLOR  "#00aa00";
  NOTES          "";
  BEGIN

    RULE                 "Shortage-KeepsNavajoWhole";
    DESCRIPTION          "This is the volume Navajo is shorted by. It's automatically added to Navajo as a &quot;ghost&quot; inflow.   This is saved when we get to the end of Cycle 3 (by the next rule).<br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) < 4.00000000 AND $ "SWITCHES.Magic Water" [] == 1.00000000;
  NAMES_COLOR  "#00aa00";
    NOTES                "";
    BEGIN

      $ "Shortage.Local Inflow" [] := IF ( $ "Navajo Reservoir.Storage" [@"t - 1"] < $ "Navajo Reservoir.MinNIIPStorage" [] )
 THEN
  "VolumeToFlow"( $ "Navajo Reservoir.MinNIIPStorage" [] - $ "Navajo Reservoir.Storage" [@"t - 1"], @"t" )
 ELSE
  0.00000000 "cfs"
 ENDIF;

    END
    UUID "{456ff907-2750-4c4f-a778-3d4adf9f5c1a}";;

    RULE                 "NIIPoffbelow5985";
    DESCRIPTION          "<br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) < 4.00000000;
  NAMES_COLOR  "#00aa00";
    NOTES                "";
    BEGIN

      IF_STATEMENT ($ "Navajo Reservoir.Pool Elevation" [] < 5985.00000000 "ft") THEN
            $ "NIIP.Diversion" [] := 0.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{b65d859d-ea70-4c57-823a-102b0c92c689}";;

    RULE                 "KnownReleaseOverwrite";
    DESCRIPTION          "Adds in recent releases that are known. Also can add in actual SPR when in the middle of the release, or some other SJRIP Adaptive Management Use.  Leave NaN's when not changing anything and this will just overwrite.<br><br><br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 3.00000000;
    NOTES                "";
    BEGIN

      $ "Navajo Reservoir.Release" [] := IF ( NOT IsNaN $ "NavajoData.KnownReleasePattern" [] )
 THEN
  $ "NavajoData.KnownReleasePattern" []
 ENDIF;

    END
    UUID "{61470810-8761-4402-ac98-87d36cc1dbaf}";;

    RULE                 "ReleaseForUSACEStorageLimit";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 3.00000000 AND "USACEWinterLimitSeason"(  );
    NOTES                "";
    BEGIN

      $ "Navajo Reservoir.Release" [] := IF ( $ "Navajo Reservoir.Storage" [@"t - 1"] > $ "NavajoData.NavFloodControlStorageLimit" [] )
 THEN
  "Min"( "VolumeToFlow"( $ "Navajo Reservoir.Storage" [@"t - 1"] - $ "NavajoData.NavFloodControlStorageLimit" [], @"t" ) + $ "Navajo Reservoir.Release" [], "MaxReleaseFunction_SafetyFactor"(  ) )
 ENDIF;

    END
    UUID "{91c5e668-2abc-4b09-aa53-cb1f5fc259f0}";;

    RULE                 "USACEStorageLimit";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 3.00000000 AND "USACEWinterLimitSeason"(  );
    NOTES                "";
    BEGIN

      $ "NavajoData.NavFloodControlStorageLimit" [] := IF ( $ "NavajoData.USACEStorageLimitPercentage" [@"t - 1"] < 0.95000000 AND ( "NavajoFloodControlLowerColumnValue"(  ) == $ "NavajoData.MaxStorage" [] AND "NavajoFloodControlUpperColumnValue"(  ) < "NavajoFloodControlLowerColumnValue"(  ) ) )
 THEN
  $ "NavajoData.MaxStorage" []
 ELSE
  $ "NavajoData.FloodControlTables" [@"t", "SumFlowsToVolume"( $ "Navajo Reservoir.Inflow", @"t", @"24:00:00 July 15, Current Year" )]
 ENDIF;

    END
    UUID "{39aef233-1c61-438f-aa1b-0c1a930fba39}";;

    RULE                 "SafeChannelCapacity";
    DESCRIPTION          "If any of the flows below Farmington are >12,000, then reduce the release by (Flow - 12,000).  Gets us pretty close.<br><br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 3.00000000;
    NOTES                "";
    BEGIN

      IF_STATEMENT ("Max"( "Max"( $ "SJFS.Inflow" [@"t - 1"], $ "SJFS.Outflow" [@"t - 1"] ), "Max"( $ "SJ4B.Outflow" [@"t - 1"], $ "SJS4.Outflow" [@"t - 1"] ) ) > 12000.00000000 "cfs") THEN
            $ "Navajo Reservoir.Release" [] := $ "Navajo Reservoir.Release" [] - "Max"( "Max"( "Max"( $ "SJFS.Inflow" [@"t - 1"], $ "SJFS.Outflow" [@"t - 1"] ), "Max"( $ "SJ4B.Outflow" [@"t - 1"], $ "SJS4.Outflow" [@"t - 1"] ) ) - 12000.00000000 "cfs", 0.00000000 "cfs" );

      END_IF_STATEMENT;

    END
    UUID "{56e4d9c1-1ea2-4e1f-bb82-c1dcb9b0f6d7}";;

  END
  UUID "{029350a1-5bd1-406b-a6d2-6c7f2b6a2685}";;

  POLICY_GROUP   "3 Cycle- Navajo 2016 Interim Operations";
  DESCRIPTION    "The new Navajo rules are based on the new SJRIP plan of using all the AW down to 6050 to maximize the spring peak release days at 5,000 cfs. The release must be at least 21 days long and no longer than 60 days.  There is no nose anymore- I take care of that using USACE flood control storage rules.  This may or may not be changed in the future back to using a nose.  The overage over 6063 is spread over summer TBF and finally a spike in the fall.<br>";
  ACTIVE         TRUE;
  NAMES_COLOR  "#00aa00";
  NOTES          "";
  BEGIN

    RULE                 "DROA Water";
    DESCRIPTION          "For Chris and Wayne's flex analysis. Try moving<br>20kaf<br>50kaf<br>100 kaf<br>Until a shortage occurs.<br><br>";
    ACTIVE               FALSE;
    RULE_EXEC_CONSTRAINT NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "GetRunCycleIndex"(  ) == 3.00000000 AND $ "SWITCHES.DROA" [] == 1.00000000;
  NAMES_COLOR  "#55aa00";
    NOTES                "";
    BEGIN

      $ "Navajo Reservoir.Release" [] := "Min"( "Max"( $ "Navajo Reservoir.Release" [] + $ "NavajoData.DROA" [], $ "Navajo Reservoir.Release" [] ), "MaxReleaseFunction_SafetyFactor"(  ) );

    END
    UUID "{49ef1172-445f-4273-b20c-6bbd4b7d5f83}";;

    RULE                 "AddSpike";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 3.00000000 AND NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "SpikeSeason"(  );
  NAMES_COLOR  "#00aa00";
    NOTES                "";
    BEGIN

      $ "Navajo Reservoir.Release" [] := "Min"( "Max"( $ "Navajo Reservoir.Release" [], $ "NavajoData.SpikeRelease" [] ), "MaxReleaseFunction_SafetyFactor"(  ) );

    END
    UUID "{0719c4fa-5418-4cad-808f-7d4440155a4a}";;

    RULE                 "CalculateSpike";
    DESCRIPTION          "Calculate spike volume for Sept 1- Sept 30 based on leftovers from nose and spike. This is a quick rule right now, should update to be more realistic (include correct ramping, etc.)  <br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 3.00000000 AND NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "SpikeSeason"(  );
  NAMES_COLOR  "#00aa00";
    NOTES                "";
    BEGIN

      $ "NavajoData.SpikeRelease" [] := IF ( $ "Navajo Reservoir.Storage" [] > "ElevationToStorage"( % "Navajo Reservoir", 6063.00000000 "feet" ) + 0.00000000 "acre-ft" )
 THEN
  "Min"( "VolumeToFlow"( $ "Navajo Reservoir.Storage" [] - ( "ElevationToStorage"( % "Navajo Reservoir", 6063.00000000 "feet" ) + 0.00000000 "acre-ft" ), @"t" ), "MaxReleaseFunction_SafetyFactor"(  ) )
 ELSE
  0.00000000 "cfs"
 ENDIF;

    END
    UUID "{fae6da4f-dfcf-4f62-bd28-78d1207fa965}";;

    RULE                 "JANLease Water";
    DESCRIPTION          "This is where we would add in JAN lease water as requested to the release.  This water would flow downstream on top of the regular release. Is this correct? Would likely change year to year. If the water has not yet been requested in any one year, then this rule is turned off.<br><br>";
    ACTIVE               FALSE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 3.00000000 AND NOT "HasRuleFiredSuccessfully"( "ThisRule" );
    NOTES                "";
    BEGIN

      $ "Navajo Reservoir.Release" [] := "Min"( "Max"( $ "Navajo Reservoir.Release" [] + $ "Navajo Contracts.JANlease" [], $ "Navajo Reservoir.Release" [] ), "MaxReleaseFunction_SafetyFactor"(  ) );

    END
    UUID "{778a22ff-f1f1-48a0-8f94-fe975a952c7a}";;

    RULE                 "IncrementRelease_Simple";
    DESCRIPTION          "This rule increments the release into blocks (accounts for gate curve, min resolution of changes)<br>8/2/2018- updated to use &quot;249cfs&quot; instead of min release function<br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 3.00000000 AND NOT "HasRuleFiredSuccessfully"( "ThisRule" );
  NAMES_COLOR  "#00aa00";
    NOTES                "";
    BEGIN

      $ "Navajo Reservoir.Release" [] := "Min"( "Ceiling"( $ "Navajo Reservoir.Release" [], $ "NavajoData.Release Increments" [] ), "MaxReleaseFunction_SafetyFactor"(  ) );

    END
    UUID "{414ad62c-7314-4707-9891-c36f5444c18a}";;

    RULE                 "ReForecast Releases_SeriesTBF - Shortage";
    DESCRIPTION          "Forecasts the release required to meet the TBF minimum downstream plus the overage.  If the function cannot find a release to use, hypsim will return a message in diagnostics and will be ineffective.<br><br>This rule fires in Cycle 3, as well as Cycle 2. The reason is just in case the SPR goes down since Cycle 2, we need to know what the release should be to meet the TBF in those few days.<br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "GetRunCycleIndex"(  ) == 3.00000000 AND $ "SWITCHES.Shortage" [] == 1.00000000;
  NAMES_COLOR  "#00aa00";
    NOTES                "";
    BEGIN

      WITH_STATEMENT (LIST forecastrelease = "HypTargetSimWithStatus"( "BelowReservoirs", $ "SJAF.Inflow", $ "NavajoData.SeriesMinRelease" [], $ "NavajoData.MaxRelease" [], { { $ "Florida River.Inflow" , $ "Florida River.Inflow" [@"t"] , @"t" } , { $ "Florida River.Inflow" , $ "Florida River.Inflow" [@"t"] , @"t + 1" } , { $ "Florida River.Inflow" , $ "Florida River.Inflow" [@"t"] , @"t + 2" } , { $ "Florida River.Inflow" , $ "Florida River.Inflow" [@"t"] , @"t + 3" } , { $ "Pine River.Inflow" , $ "Pine River.Inflow" [@"t"] , @"t" } , { $ "Pine River.Inflow" , $ "Pine River.Inflow" [@"t"] , @"t + 1" } , { $ "Pine River.Inflow" , $ "Pine River.Inflow" [@"t"] , @"t + 2" } , { $ "Pine River.Inflow" , $ "Pine River.Inflow" [@"t"] , @"t + 3" } , { $ "Basin Creek Y Animas.Inflow2" , $ "Basin Creek Y Animas.Inflow2" [@"t"] , @"t" } , { $ "Basin Creek Y Animas.Inflow2" , $ "Basin Creek Y Animas.Inflow2" [@"t"] , @"t + 1" } , { $ "Basin Creek Y Animas.Inflow2" , $ "Basin Creek Y Animas.Inflow2" [@"t"] , @"t + 2" } , { $ "Basin Creek Y Animas.Inflow2" , $ "Basin Creek Y Animas.Inflow2" [@"t"] , @"t + 3" } , { $ "SJAF.Local Inflow" , $ "SJAF.Local Inflow" [@"t - 1"] , @"t" } , { $ "SJAF.Local Inflow" , $ "SJAF.Local Inflow" [@"t - 1"] , @"t + 1" } , { $ "SJAF.Local Inflow" , $ "SJAF.Local Inflow" [@"t - 1"] , @"t + 2" } , { $ "SJAF.Local Inflow" , $ "SJAF.Local Inflow" [@"t - 1"] , @"t + 3" } , { $ "SJFS.Local Inflow" , $ "SJFS.Local Inflow" [@"t - 1"] , @"t" } , { $ "SJFS.Local Inflow" , $ "SJFS.Local Inflow" [@"t - 1"] , @"t + 1" } , { $ "SJFS.Local Inflow" , $ "SJFS.Local Inflow" [@"t - 1"] , @"t + 2" } , { $ "SJFS.Local Inflow" , $ "SJFS.Local Inflow" [@"t - 1"] , @"t + 3" } , { $ "SJS4.Local Inflow" , $ "SJS4.Local Inflow" [@"t - 1"] , @"t" } , { $ "SJS4.Local Inflow" , $ "SJS4.Local Inflow" [@"t - 1"] , @"t + 1" } , { $ "SJS4.Local Inflow" , $ "SJS4.Local Inflow" [@"t - 1"] , @"t + 2" } , { $ "SJS4.Local Inflow" , $ "SJS4.Local Inflow" [@"t - 1"] , @"t + 3" } }, $ "SJS4.Outflow", @"t + 3", "Min"( $ "NavajoData.ShortageMinTBF" [] + $ "NavajoData.SummerTBFOverage" [], $ "NavajoData.MAX TBF" [] ), 10.00000000 "cfs", 40.00000000, 0.00000000 )) DO
            $ "NavajoData.ReleaseToMeetTBF" [] := GET @INDEX 1.00000000 FROM forecastrelease;

      END_WITH_STATEMENT;

    END
    UUID "{578581f8-2b6c-4dcd-8d7a-4e0e8f406eb6}";;

    RULE                 "ReForecast Releases";
    DESCRIPTION          "Forecasts the release required to meet the TBF minimum downstream plus the overage.  If the function cannot find a release to use, hypsim will return a message in diagnostics and will be ineffective.<br><br>This rule fires in Cycle 3, as well as Cycle 2. The reason is just in case the SPR goes down since Cycle 2, we need to know what the release should be to meet the TBF in those few days.<br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "GetRunCycleIndex"(  ) == 3.00000000 AND $ "SWITCHES.Shortage" [] == 0.00000000;
  NAMES_COLOR  "#00aa00";
    NOTES                "";
    BEGIN

      WITH_STATEMENT (LIST forecastrelease = "HypTargetSimWithStatus"( "BelowReservoirs", $ "SJAF.Inflow", $ "NavajoData.SeriesMinRelease" [], $ "NavajoData.MaxRelease" [], { { $ "Florida River.Inflow" , $ "Florida River.Inflow" [@"t"] , @"t" } , { $ "Florida River.Inflow" , $ "Florida River.Inflow" [@"t"] , @"t + 1" } , { $ "Florida River.Inflow" , $ "Florida River.Inflow" [@"t"] , @"t + 2" } , { $ "Florida River.Inflow" , $ "Florida River.Inflow" [@"t"] , @"t + 3" } , { $ "Pine River.Inflow" , $ "Pine River.Inflow" [@"t"] , @"t" } , { $ "Pine River.Inflow" , $ "Pine River.Inflow" [@"t"] , @"t + 1" } , { $ "Pine River.Inflow" , $ "Pine River.Inflow" [@"t"] , @"t + 2" } , { $ "Pine River.Inflow" , $ "Pine River.Inflow" [@"t"] , @"t + 3" } , { $ "Basin Creek Y Animas.Inflow2" , $ "Basin Creek Y Animas.Inflow2" [@"t"] , @"t" } , { $ "Basin Creek Y Animas.Inflow2" , $ "Basin Creek Y Animas.Inflow2" [@"t"] , @"t + 1" } , { $ "Basin Creek Y Animas.Inflow2" , $ "Basin Creek Y Animas.Inflow2" [@"t"] , @"t + 2" } , { $ "Basin Creek Y Animas.Inflow2" , $ "Basin Creek Y Animas.Inflow2" [@"t"] , @"t + 3" } , { $ "SJAF.Local Inflow" , $ "SJAF.Local Inflow" [@"t - 1"] , @"t" } , { $ "SJAF.Local Inflow" , $ "SJAF.Local Inflow" [@"t - 1"] , @"t + 1" } , { $ "SJAF.Local Inflow" , $ "SJAF.Local Inflow" [@"t - 1"] , @"t + 2" } , { $ "SJAF.Local Inflow" , $ "SJAF.Local Inflow" [@"t - 1"] , @"t + 3" } , { $ "SJFS.Local Inflow" , $ "SJFS.Local Inflow" [@"t - 1"] , @"t" } , { $ "SJFS.Local Inflow" , $ "SJFS.Local Inflow" [@"t - 1"] , @"t + 1" } , { $ "SJFS.Local Inflow" , $ "SJFS.Local Inflow" [@"t - 1"] , @"t + 2" } , { $ "SJFS.Local Inflow" , $ "SJFS.Local Inflow" [@"t - 1"] , @"t + 3" } , { $ "SJS4.Local Inflow" , $ "SJS4.Local Inflow" [@"t - 1"] , @"t" } , { $ "SJS4.Local Inflow" , $ "SJS4.Local Inflow" [@"t - 1"] , @"t + 1" } , { $ "SJS4.Local Inflow" , $ "SJS4.Local Inflow" [@"t - 1"] , @"t + 2" } , { $ "SJS4.Local Inflow" , $ "SJS4.Local Inflow" [@"t - 1"] , @"t + 3" } }, $ "SJS4.Outflow", @"t + 3", "Min"( $ "NavajoData.MinTBF" [] + $ "NavajoData.SummerTBFOverage" [], $ "NavajoData.MAX TBF" [] ), 10.00000000 "cfs", 40.00000000, 0.00000000 )) DO
            $ "NavajoData.ReleaseToMeetTBF" [] := GET @INDEX 1.00000000 FROM forecastrelease;

      END_WITH_STATEMENT;

    END
    UUID "{982e92eb-ef85-4be6-857a-08269d5d857c}";;

    RULE                 "CalculateOverageInCFS";
    DESCRIPTION          "This rule says what would I need to release today in order to have 0 AW left on Sept 30th? It's total outflow so I subtract NIIP. Not exact but gets closer and closer by Sept 30th.<br><br><br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "GetRunCycleIndex"(  ) == 3.00000000 AND "SummerBaseflowSeason"(  );
  NAMES_COLOR  "#00aa00";
    NOTES                "";
    BEGIN

      $ "NavajoData.SummerTBFOverage" [] := "Max"( "OutflowRequredToMeetTPE1"( % "Navajo Reservoir", $ "Navajo Reservoir.Inflow", $ "Navajo Reservoir.Storage", $ "NavajoData.OpSpillEWYST" ) - $ "NIIP.Diversion" [], 0.00000000 "cfs" );

    END
    UUID "{a8a83070-c487-4132-876f-2f5e31294d53}";;

    RULE                 "InsertNewSPR";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 3.00000000 AND NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "SpringPeakReleaseSeason"(  );
  NAMES_COLOR  "#00aa00";
    NOTES                "";
    BEGIN

      $ "Navajo Reservoir.Release" [] := IF ( $ "NavajoData.Cycle3SpringPeakRelease" [] > $ "Navajo Reservoir.Release" [] )
 THEN
  "Min"( $ "NavajoData.Cycle3SpringPeakRelease" [], "MaxReleaseFunction_SafetyFactor"(  ) )
 ENDIF;

    END
    UUID "{6ed4309c-e7c1-4510-b0bf-96e8f32468f2}";;

    RULE                 "SetCycle2OperationalRelease";
    DESCRIPTION          "Sets release as whatever the operational release from Cycle 2 was (to start)<br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "GetRunCycleIndex"(  ) == 3.00000000;
  NAMES_COLOR  "#00aa00";
    NOTES                "";
    BEGIN

      $ "Navajo Reservoir.Release" [] := $ "NavajoData.Cycle2OperationalReleases" [];

    END
    UUID "{7c44650d-e191-4d62-8167-495d6bfe27dd}";;

    RULE                 "Count SPR Days";
    DESCRIPTION          "Count the days so we can subtract 350 cfs baseflow";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 3.00000000 AND NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "SpringPeakReleaseSeason"(  );
  NAMES_COLOR  "#00aa00";
    NOTES                "";
    BEGIN

      $ "NavajoData.Cycle3NumSPRDays" [] := IF ( $ "NavajoData.Cycle3SpringPeakRelease" [] > 4599.00000000 "cfs" )
 THEN
  1.00000000
 ELSE
  0.00000000
 ENDIF;

    END
    UUID "{47727a3a-2ae0-48bf-ac1b-c4332a8f059a}";;

    RULE                 "SetSPRbyVolume";
    DESCRIPTION          "this will pick the SPR based on volume. The 288,000 af is the equivalent to a 21-day SPR with 7-day ramp up and 14-day ramp down as rec by SJRIP. This number can be reduced to 0 af if we want to have the lower range releases as a possibility. SNB  2/2/23<br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 3.00000000 AND NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND $ "SWITCHES.LongRampTesting" [] == 0.00000000;
  NAMES_COLOR  "#00aa00";
    NOTES                "";
    BEGIN

      $ "NavajoData.Cycle3SpringPeakRelease" [] := IF ( "SpringPeakReleaseSeason"(  ) )
 THEN
  IF ( $ "NavajoData.Cycle3AvailableWater" [@"t"] > $ "NavajoData.MinSPRVolumeConsidered" [] )
  THEN
   $ "NavajoData.SPRTables Low Range_byVolume" [@"t", $ "NavajoData.Cycle3AvailableWater" [@"t"]]
  ELSE
   $ "NavajoData.SPRTables Low Range_byVolume" [@"t", 0.00000000 "acre-feet"]
  ENDIF
 ENDIF;

    END
    UUID "{a7c1cb9d-f003-4b2d-a12e-0f3f83144c22}";;

    RULE                 "SetSPRbyVolume with Long Ramps";
    DESCRIPTION          "this will pick the SPR based on volume. The 288,000 af is the equivalent to a 21-day SPR with 7-day ramp up and 14-day ramp down as rec by SJRIP. This number can be reduced to 0 af if we want to have the lower range releases as a possibility. SNB  2/2/23<br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 3.00000000 AND NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND $ "SWITCHES.LongRampTesting" [] == 1.00000000;
  NAMES_COLOR  "#00aa00";
    NOTES                "";
    BEGIN

      $ "NavajoData.Cycle3SpringPeakRelease" [] := IF ( "SpringPeakReleaseSeason"(  ) )
 THEN
  IF ( $ "NavajoData.Cycle3AvailableWater" [@"t"] > $ "NavajoData.MinSPRVolumeConsidered" [] )
  THEN
   $ "NavajoData.SPRTables Low Range_byVolume_LongRamps" [@"t", $ "NavajoData.Cycle3AvailableWater" [@"t"]]
  ELSE
   $ "NavajoData.SPRTables Low Range_byVolume" [@"t", 0.00000000 "acre-feet"]
  ENDIF
 ENDIF;

    END
    UUID "{efa71347-3719-4cd1-a6ac-e9cfd116b1c5}";;

    RULE                 "CalcMaxDaysAtPeak";
    DESCRIPTION          "This rule takes the AW and subtracts an appx 7-day ramp-up volume over base, and a 12-day ramp-down volume over base. Then it divdes the remainder by the volume of a single peak day over base. This returns the total number of days we will run at 5,000 cfs.  In the end, it may be +/- a day or two.<br><br>Doesn't need to be a round number since we're using tables.<br><br>Change the 50,000 number if changing the # of ramping days, and point to the correct SPR ramp table.<br>3-day:18,000<br>7-day: 42,000<br>10-day: 61,000<br><br>Ramp-down (12-days): 65,000";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 3.00000000 AND NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "SpringPeakReleaseSeason"(  );
    NOTES                "";
    BEGIN

      $ "NavajoData.Cycle3MaxDaysAtPeak" [] := "Max"( "Floor"( ( $ "NavajoData.Cycle3AvailableWater" [] - 42000.00000000 "acre-feet" - 65000.00000000 "acre-ft" ) / 9223.00000000 "acre-ft" - 1.00000000, 1.00000000 ), 0.00000000 );

    END
    UUID "{e42d88a8-6a74-4d15-927a-55ee1d291357}";;

    RULE                 "AW Correction";
    DESCRIPTION          "When the resulting EOWST is not exactly 6050 ft, use this to adjust the AW calculation<br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 3.00000000 AND NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "SpringPeakReleaseSeason"(  );
  NAMES_COLOR  "#ff0000";
    NOTES                "";
    BEGIN

      $ "NavajoData.Cycle3AvailableWater" [] := $ "NavajoData.Cycle3AvailableWater" [] - $ "NavajoData.AWCorrection" [];

    END
    UUID "{daa87de3-09c7-45da-ae23-6544cf8c1a58}";;

    RULE                 "Recalculated Available Water";
    DESCRIPTION          "AW calculation based on new calculation using EOWYST of 6050 ft. The AW calculated is the volume OVER base (350 cfs) that would be available.  ";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 3.00000000 AND NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "SpringPeakReleaseSeason"(  );
  NAMES_COLOR  "#00aa00";
    NOTES                "";
    BEGIN

      $ "NavajoData.Cycle3AvailableWater" [] := IF ( @"t" == "FirstAWCalcDate"(  ) )
 THEN
  $ "Navajo Reservoir.Storage" [@"t - 1"] + "SumFlowsToVolume"( $ "Navajo Reservoir.Inflow", @"t", @"24:00:00 September 30, Current Year" ) - "SumFlowsToVolume"( $ "Navajo Reservoir.Diversion", @"t", @"24:00:00 September 30, Current Year" ) - "SumSlot"( $ "Navajo Reservoir.Evaporation", @"t", @"24:00:00 September 30, Current Year" ) - "SumFlowsToVolume"( $ "NavajoData.Cycle2OperationalReleases", @"t", @"24:00:00 September 30, Current Year" ) - "ElevationToStorage"( % "Navajo Reservoir", $ "NavajoData.AWEOWYST" [] )
 ELSE
  $ "NavajoData.Cycle3AvailableWater" ["FirstAWCalcDate"(  )]
 ENDIF;

    END
    UUID "{5efc3c26-f8a7-4633-b6e1-389210940b5a}";;

  END
  UUID "{80e0fda8-88e6-4212-a268-c049158fc79d}";;

  POLICY_GROUP   "2 Cycle- Navajo Rules";
  DESCRIPTION    "This is a &quot;first pass &quot; at operating Navajo. The purpose of this cycle is to first calculate what &quot;Operational releases&quot; are needed to satisfy the minimum TBF downstream.  This must be calculated before the third cycle so that the Available Water for the year can be calculated.  A set of &quot;seed&quot; spring peak releases are used (Manual Spring Peak Release) just to keep the pool elevation and storage at Navajo to something realistic, rather than allowing it to build up.  For operational forecasts, it just uses last month's releases.    At the end of this, the operational releases are stored for Cycle 3.";
  ACTIVE         TRUE;
  NAMES_COLOR  "#aa00ff";
  NOTES          "";
  BEGIN

    RULE                 "SaveCycle2OperationalReleases";
    DESCRIPTION          "Operational releases are just saved for Cycle 2 calculations.<br><br>NaN function in there because there are a few NaN's at the very end of the run in ReleasetomeetTBF (3-day lag)<br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 2.00000000 AND NOT "HasRuleFiredSuccessfully"( "ThisRule" );
    NOTES                "";
    BEGIN

      $ "NavajoData.Cycle2OperationalReleases" [] := IF ( IsNaN $ "NavajoData.ReleaseToMeetTBF" [] )
 THEN
  $ "NavajoData.SeriesMinRelease" []
 ELSE
  $ "NavajoData.ReleaseToMeetTBF" []
 ENDIF;

    END
    UUID "{b8e30ed1-8f84-45d4-b835-3cf9d2348b97}";;

    RULE                 "StoreCycle2Elevation";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 2.00000000 AND NOT "HasRuleFiredSuccessfully"( "ThisRule" );
    NOTES                "";
    BEGIN

      $ "NavajoData.Cycle2NavajoElev" [] := $ "Navajo Reservoir.Pool Elevation" [];

    END
    UUID "{2cab8a0a-afec-4c78-9592-4ae2524926e0}";;

    RULE                 "PickRelease";
    DESCRIPTION          "Sets release to the forecast releases.  No rounding yet for this iteration.<br><br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "GetRunCycleIndex"(  ) == 2.00000000;
    NOTES                "";
    BEGIN

      $ "Navajo Reservoir.Release" [] := "Max"( $ "NavajoData.ReleaseToMeetTBF" [], $ "NavajoData.SeriesMinRelease" [] );

    END
    UUID "{57aa386f-78fb-4a55-b534-c53d81e6d8fe}";;

    RULE                 "Forecast Releases_SeriesTBF - Shortage";
    DESCRIPTION          "Forecasts the release required to meet the TBF minimum downstream.  If the function cannot find a release to use, hypsim will return a message in diagnostics and will be ineffective.  This is normal and expected during high flow releases like SPR or spike.<br><br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "GetRunCycleIndex"(  ) == 2.00000000 AND $ "SWITCHES.Shortage" [] == 1.00000000;
  NAMES_COLOR  "#aa00ff";
    NOTES                "";
    BEGIN

      WITH_STATEMENT (LIST forecastrelease = "HypTargetSimWithStatus"( "BelowReservoirs", $ "SJAF.Inflow", $ "NavajoData.SeriesMinRelease" [], $ "NavajoData.MaxRelease" [], { { $ "Florida River.Inflow" , $ "Florida River.Inflow" [@"t"] , @"t" } , { $ "Florida River.Inflow" , $ "Florida River.Inflow" [@"t"] , @"t + 1" } , { $ "Florida River.Inflow" , $ "Florida River.Inflow" [@"t"] , @"t + 2" } , { $ "Florida River.Inflow" , $ "Florida River.Inflow" [@"t"] , @"t + 3" } , { $ "Pine River.Inflow" , $ "Pine River.Inflow" [@"t"] , @"t" } , { $ "Pine River.Inflow" , $ "Pine River.Inflow" [@"t"] , @"t + 1" } , { $ "Pine River.Inflow" , $ "Pine River.Inflow" [@"t"] , @"t + 2" } , { $ "Pine River.Inflow" , $ "Pine River.Inflow" [@"t"] , @"t + 3" } , { $ "Basin Creek Y Animas.Inflow2" , $ "Basin Creek Y Animas.Inflow2" [@"t"] , @"t" } , { $ "Basin Creek Y Animas.Inflow2" , $ "Basin Creek Y Animas.Inflow2" [@"t"] , @"t + 1" } , { $ "Basin Creek Y Animas.Inflow2" , $ "Basin Creek Y Animas.Inflow2" [@"t"] , @"t + 2" } , { $ "Basin Creek Y Animas.Inflow2" , $ "Basin Creek Y Animas.Inflow2" [@"t"] , @"t + 3" } , { $ "SJAF.Local Inflow" , $ "SJAF.Local Inflow" [@"t - 1"] , @"t" } , { $ "SJAF.Local Inflow" , $ "SJAF.Local Inflow" [@"t - 1"] , @"t + 1" } , { $ "SJAF.Local Inflow" , $ "SJAF.Local Inflow" [@"t - 1"] , @"t + 2" } , { $ "SJAF.Local Inflow" , $ "SJAF.Local Inflow" [@"t - 1"] , @"t + 3" } , { $ "SJFS.Local Inflow" , $ "SJFS.Local Inflow" [@"t - 1"] , @"t" } , { $ "SJFS.Local Inflow" , $ "SJFS.Local Inflow" [@"t - 1"] , @"t + 1" } , { $ "SJFS.Local Inflow" , $ "SJFS.Local Inflow" [@"t - 1"] , @"t + 2" } , { $ "SJFS.Local Inflow" , $ "SJFS.Local Inflow" [@"t - 1"] , @"t + 3" } , { $ "SJS4.Local Inflow" , $ "SJS4.Local Inflow" [@"t - 1"] , @"t" } , { $ "SJS4.Local Inflow" , $ "SJS4.Local Inflow" [@"t - 1"] , @"t + 1" } , { $ "SJS4.Local Inflow" , $ "SJS4.Local Inflow" [@"t - 1"] , @"t + 2" } , { $ "SJS4.Local Inflow" , $ "SJS4.Local Inflow" [@"t - 1"] , @"t + 3" } }, $ "SJS4.Outflow", @"t + 3", $ "NavajoData.ShortageMinTBF" [], 10.00000000 "cfs", 40.00000000, 0.00000000 )) DO
            $ "NavajoData.ReleaseToMeetTBF" [] := GET @INDEX 1.00000000 FROM forecastrelease;

      END_WITH_STATEMENT;

    END
    UUID "{1bfec7c0-e352-445a-ae9a-dc4153dd53a3}";;

    RULE                 "Forecast Releases";
    DESCRIPTION          "Forecasts the release required to meet the TBF minimum downstream.  If the function cannot find a release to use, hypsim will return a message in diagnostics and will be ineffective.<br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "GetRunCycleIndex"(  ) == 2.00000000 AND $ "SWITCHES.Shortage" [] == 0.00000000;
    NOTES                "";
    BEGIN

      WITH_STATEMENT (LIST forecastrelease = "HypTargetSimWithStatus"( "BelowReservoirs", $ "SJAF.Inflow", $ "NavajoData.SeriesMinRelease" [], $ "NavajoData.MaxRelease" [], { { $ "Florida River.Inflow" , $ "Florida River.Inflow" [@"t"] , @"t" } , { $ "Florida River.Inflow" , $ "Florida River.Inflow" [@"t"] , @"t + 1" } , { $ "Florida River.Inflow" , $ "Florida River.Inflow" [@"t"] , @"t + 2" } , { $ "Florida River.Inflow" , $ "Florida River.Inflow" [@"t"] , @"t + 3" } , { $ "Pine River.Inflow" , $ "Pine River.Inflow" [@"t"] , @"t" } , { $ "Pine River.Inflow" , $ "Pine River.Inflow" [@"t"] , @"t + 1" } , { $ "Pine River.Inflow" , $ "Pine River.Inflow" [@"t"] , @"t + 2" } , { $ "Pine River.Inflow" , $ "Pine River.Inflow" [@"t"] , @"t + 3" } , { $ "Basin Creek Y Animas.Inflow2" , $ "Basin Creek Y Animas.Inflow2" [@"t"] , @"t" } , { $ "Basin Creek Y Animas.Inflow2" , $ "Basin Creek Y Animas.Inflow2" [@"t"] , @"t + 1" } , { $ "Basin Creek Y Animas.Inflow2" , $ "Basin Creek Y Animas.Inflow2" [@"t"] , @"t + 2" } , { $ "Basin Creek Y Animas.Inflow2" , $ "Basin Creek Y Animas.Inflow2" [@"t"] , @"t + 3" } , { $ "SJAF.Local Inflow" , $ "SJAF.Local Inflow" [@"t - 1"] , @"t" } , { $ "SJAF.Local Inflow" , $ "SJAF.Local Inflow" [@"t - 1"] , @"t + 1" } , { $ "SJAF.Local Inflow" , $ "SJAF.Local Inflow" [@"t - 1"] , @"t + 2" } , { $ "SJAF.Local Inflow" , $ "SJAF.Local Inflow" [@"t - 1"] , @"t + 3" } , { $ "SJFS.Local Inflow" , $ "SJFS.Local Inflow" [@"t - 1"] , @"t" } , { $ "SJFS.Local Inflow" , $ "SJFS.Local Inflow" [@"t - 1"] , @"t + 1" } , { $ "SJFS.Local Inflow" , $ "SJFS.Local Inflow" [@"t - 1"] , @"t + 2" } , { $ "SJFS.Local Inflow" , $ "SJFS.Local Inflow" [@"t - 1"] , @"t + 3" } , { $ "SJS4.Local Inflow" , $ "SJS4.Local Inflow" [@"t - 1"] , @"t" } , { $ "SJS4.Local Inflow" , $ "SJS4.Local Inflow" [@"t - 1"] , @"t + 1" } , { $ "SJS4.Local Inflow" , $ "SJS4.Local Inflow" [@"t - 1"] , @"t + 2" } , { $ "SJS4.Local Inflow" , $ "SJS4.Local Inflow" [@"t - 1"] , @"t + 3" } }, $ "SJS4.Outflow", @"t + 3", $ "NavajoData.MinTBF" [], 10.00000000 "cfs", 40.00000000, 0.00000000 )) DO
            $ "NavajoData.ReleaseToMeetTBF" [] := GET @INDEX 1.00000000 FROM forecastrelease;

      END_WITH_STATEMENT;

    END
    UUID "{e25695cd-3f92-4995-9569-4766970b3e6f}";;

    RULE                 "SetMinRelease";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "GetRunCycleIndex"(  ) == 2.00000000;
    NOTES                "";
    BEGIN

      $ "Navajo Reservoir.Release" [] := $ "NavajoData.SeriesMinRelease" [];

    END
    UUID "{a641761d-88ff-464d-8b2c-b4dee0ca0de0}";;

    RULE                 "Set Series Min Release";
    DESCRIPTION          "This used to set min release by pool elevation, but now it sets min release based on if we are running min/most/max.  Ideally the min release would either be consistent no matter what, or would be based on the forecast.<br><br>Typically we don't release as low as 250 cfs unless it looks like we are getting close to shortage, but 300 is a pretty normal min most of the time. I put 400 for the max probable.<br><br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "GetRunCycleIndex"(  ) == 2.00000000;
    NOTES                "";
    BEGIN

      $ "NavajoData.SeriesMinRelease" [] := IF ( "SummerBaseflowSeason"(  ) )
 THEN
  499.00000000 "cfs"
 ELSE
  299.00000000 "cfs"
 ENDIF;

    END
    UUID "{5ee950c3-8b4d-4bac-aa3c-c3190350a153}";;

    RULE                 "Set NVRN5 Inflow";
    DESCRIPTION          "According to UC and HDB calculation. Evap is included because it's int he change in storage calculation- and it needs to cancel out (mod unreg assumes the project isn't there, so evap wouldn't occur)";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 2.00000000;
  NAMES_COLOR  "#aa00ff";
    NOTES                "";
    BEGIN

      $ "Navajo Reservoir.Inflow" [] := $ "NavajoData.CBRFC Inflow" [] - $ "San Juan Chama Project.Diversion" [] - "VolumeToFlow"( $ "Vallecito Reservoir.Storage" [] - $ "Vallecito Reservoir.Storage" [@"t - 1"], @"t" ) - "VolumeToFlow"( $ "Vallecito Reservoir.Evaporation" [], @"t" );

    END
    UUID "{ef1974e8-cf44-4673-a2cf-a45b5edaba97}";;

  END
  UUID "{18b87be0-a2df-4945-8d10-3a7ba04bdf8c}";;

  POLICY_GROUP   "1 Cycle- Nighthorse Rules";
  DESCRIPTION    "Rules governing the operation of Ridges Basin and ALP";
  ACTIVE         TRUE;
  NAMES_COLOR  "#0055ff";
  NOTES          "";
  BEGIN

    RULE                 "MaxStorageSpill";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Nighthorse Reservoir.Outflow" [] := IF ( $ "Nighthorse Reservoir.Storage" [] > $ "NighthorseData.MaxStorage" [] + $ "NighthorseData.StorageBuffer" [] )
 THEN
  "VolumeToFlow"( $ "Nighthorse Reservoir.Storage" [] - ( $ "NighthorseData.MaxStorage" [] + $ "NighthorseData.StorageBuffer" [] ), @"t" ) + $ "Nighthorse Reservoir.Outflow" []
 ENDIF;

    END
    UUID "{7aa9cc4f-2abd-42bd-bccd-0fa6cb552c3e}";;

    RULE                 "MaxStorageStopPumping";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      IF_STATEMENT ($ "Nighthorse Reservoir.Storage" [] > $ "NighthorseData.MaxStorage" []) THEN
            $ "Nighthorse Reservoir.Flow FROM Pumped Storage" [] := 0.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{76cede7d-cb20-4e55-8662-70590b921956}";;

    RULE                 "DownstreamDemands";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Nighthorse Reservoir.Outflow" [] := $ "NighthorseData.DownstreamDemand" [];

    END
    UUID "{60efd901-87d0-4848-b3aa-630ec01c0d3e}";;

    RULE                 "PumpingLossToAnimas";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Animas abv Nighthorse.Variable GainLoss" [] := - 1.00000000 * $ "Nighthorse Reservoir.Flow FROM Pumped Storage" [];

    END
    UUID "{d0ae3825-49b0-461f-b360-f9a388e5c194}";;

    RULE                 "PumpingOverride";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Nighthorse Reservoir.Flow FROM Pumped Storage" [] := IF ( NOT IsNaN $ "NighthorseData.PumpOverride" [] )
 THEN
  $ "NighthorseData.PumpOverride" []
 ENDIF;

    END
    UUID "{e179cfd7-8566-4b91-956e-75a4d37c051b}";;

    RULE                 "PumpingLimitations";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Nighthorse Reservoir.Flow FROM Pumped Storage" [] := "Min"( $ "Nighthorse Reservoir.Flow FROM Pumped Storage" [], "Min"( $ "NighthorseData.MaxDPPPump" [], $ "NighthorseData.Available To Pump" [] ) );

    END
    UUID "{63d78bd9-042d-411b-8011-555a654f12d5}";;

    RULE                 "PumpingOperation-withrefill-choose step pump THIS YEAR";
    DESCRIPTION          "If it's the first day of pumping, then we pick the appropriate step pump. Then anytime over the next two months that the reservoir is < 6882, the pumps kick back on and choose the May 1 pump rate. This will get messy once we get into actual pumping season, and we will need to rely on realtime pump estimates.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000 AND "ALP Pumping Season"(  ) AND NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND @"t" < @"24:00:00 December 31, 2023";
    NOTES                "";
    BEGIN

      $ "Nighthorse Reservoir.Flow FROM Pumped Storage" [] := IF ( "IsFirstDayOfPumping"(  ) )
 THEN
  $ "NighthorseData.ManualPumpStep" []
 ELSE
  IF ( $ "Nighthorse Reservoir.Pool Elevation" [@"t - 1"] < $ "NighthorseData.MaxElev" [] )
  THEN
   $ "NighthorseData.ManualPumpStep" []
  ELSE
   0.00000000 "cfs"
  ENDIF
 ENDIF;

    END
    UUID "{ecfd5acd-c5b5-4767-bf11-ad5602343c76}";;

    RULE                 "PumpingOperation-withrefill";
    DESCRIPTION          "If it's the first day of pumping, then we pick the appropriate step pump. Then anytime over the next two months that the reservoir is < 6882, the pumps kick back on and choose the May 1 pump rate. This will get messy once we get into actual pumping season, and we will need to rely on realtime pump estimates.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000 AND "ALP Pumping Season"(  ) AND NOT "HasRuleFiredSuccessfully"( "ThisRule" );
    NOTES                "";
    BEGIN

      $ "Nighthorse Reservoir.Flow FROM Pumped Storage" [] := IF ( "IsFirstDayOfPumping"(  ) )
 THEN
  "PickStepPump"(  )
 ELSE
  IF ( $ "Nighthorse Reservoir.Pool Elevation" [@"t - 1"] < $ "NighthorseData.MaxElev" [] )
  THEN
   $ "Nighthorse Reservoir.Flow FROM Pumped Storage" [@"24:00:00 May 1, Current Year"]
  ELSE
   0.00000000 "cfs"
  ENDIF
 ENDIF;

    END
    UUID "{e506236c-31e9-4946-959a-aa3025d204f2}";;

    RULE                 "SetPumpsToZero";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Nighthorse Reservoir.Flow FROM Pumped Storage" [] := 0.00000000 "cfs";

    END
    UUID "{0fc37549-0668-4cf6-87f8-685730f7b1b9}";;

  END
  UUID "{7ee7d47d-8ac7-4bac-92e6-746ec64917cd}";;

  POLICY_GROUP   "1 Cycle- Lemon Rules";
  DESCRIPTION    "";
  ACTIVE         TRUE;
  NAMES_COLOR  "#0055ff";
  NOTES          "";
  BEGIN

    RULE                 "MaxStorage";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Lemon Reservoir.Outflow" [] := IF ( $ "Lemon Reservoir.Storage" [] > $ "LemonData.MaxStorage" [] )
 THEN
  "VolumeToFlow"( $ "Lemon Reservoir.Storage" [] - $ "LemonData.MaxStorage" [], @"t" ) + $ "Lemon Reservoir.Outflow" []
 ENDIF;

    END
    UUID "{e4a14216-7f50-436b-ac48-76d0d63d0a35}";;

    RULE                 "MaxSafeChannelRelease";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Lemon Reservoir.Outflow" [] := IF ( $ "Lemon Reservoir.Outflow" [] > $ "LemonData.Safe Channel Capacity" [] )
 THEN
  $ "LemonData.Safe Channel Capacity" []
 ENDIF;

    END
    UUID "{6c0243d9-7f06-44de-82b3-47977ca7d6c9}";;

    RULE                 "KnownRelease";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Lemon Reservoir.Outflow" [] := IF ( NOT IsNaN $ "LemonData.KnownRelease" [] )
 THEN
  $ "LemonData.KnownRelease" []
 ENDIF;

    END
    UUID "{154745e8-d416-4bf6-bed5-cb3c2016abff}";;

    RULE                 "Release Smoothing";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Lemon Reservoir.Outflow" [] := IF ( $ "Lemon Reservoir.Outflow" [] < $ "Lemon Reservoir.Outflow" [@"t - 1"] AND $ "Lemon Reservoir.Storage" [@"t - 1"] / $ "LemonData.FloodControlStorageLimit" [@"t - 1"] >= $ "LemonData.DownwardSmoothingACE_ResetValue" [] )
 THEN
  $ "Lemon Reservoir.Outflow" [@"t - 1"]
 ENDIF;

    END
    UUID "{1dabdfb7-0983-4a1b-942a-c41be5a791a7}";;

    RULE                 "FloodControlLimits";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Lemon Reservoir.Outflow" [] := IF ( @"t" >= @"March 20" AND @"t" < @"July 11" AND $ "Lemon Reservoir.Storage" [] > $ "LemonData.FloodControlStorageLimit" [] * $ "LemonData.PercentofACE_Flood_Control_Limit" [] )
 THEN
  "VolumeToFlow"( $ "Lemon Reservoir.Storage" [] - ( $ "LemonData.FloodControlStorageLimit" [] * $ "LemonData.PercentofACE_Flood_Control_Limit" [] ), @"t" ) + $ "Lemon Reservoir.Outflow" []
 ENDIF;

    END
    UUID "{b0ee09a3-e0d4-4e49-98d4-b1fb8449526a}";;

    RULE                 "SetFloodControlStorageLimit";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "LemonData.FloodControlStorageLimit" [] := IF ( @"t" >= @"March 20" AND @"t" <= @"July 10" )
 THEN
  "TableInterpolation3D"( $ "LemonData.Flood Control Table", 0.00000000, "GetDayOfYear"( @"t" ), 1.00000000, "Remaining Spring Runoff Volume"( % "Lemon Reservoir" ), 2.00000000, @"t" )
 ENDIF;

    END
    UUID "{e6bfd2cb-1026-49d9-a421-cc00664fbf94}";;

    RULE                 "IrrigationPondFilling";
    DESCRIPTION          "Stock pond filling over five days of 500 af on top of typical release (50 cfs/day plus 11 cfs/day = 61 cfs per day) Using 60 just because historically he doesn't seem to go above 60. <br>SNB Sept 2021<br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Lemon Reservoir.Outflow" [] := IF ( "LemonPondFillingSeason"(  ) AND $ "Lemon Reservoir.Outflow" [] < 50.00000000 "cfs" )
 THEN
  60.00000000 "cfs"
 ENDIF;

    END
    UUID "{c40cc892-c674-4890-a6a1-1f28e9ea7283}";;

    RULE                 "SetRemainingSpringRunoff";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "LemonData.RemainingSpringRunoff" [] := "Remaining Spring Runoff Volume"( % "Lemon Reservoir" );

    END
    UUID "{f4c84f73-c70e-4c81-a59a-9f3e4dc7454a}";;

    RULE                 "MinEOYStorage";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "GetRunCycleIndex"(  ) == 1.00000000 AND "Lemon Irrigation Season"(  );
    NOTES                "";
    BEGIN

      $ "Lemon Reservoir.Outflow" [] := IF ( $ "Lemon Reservoir.Storage" [] < $ "LemonData.MinEOYStorage" [] )
 THEN
  "Min"( $ "Lemon Reservoir.Inflow" [], $ "LemonData.MedianDemands" [] )
 ENDIF;

    END
    UUID "{6ad2f5cb-ca06-45ae-8160-c651fee901d8}";;

    RULE                 "Irrigation Release- NEW- no scaling, just ends";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Lemon Reservoir.Outflow" [] := IF ( "Lemon Irrigation Season"(  ) AND $ "Lemon Reservoir.Outflow" [] < $ "LemonData.MedianDemands" [] )
 THEN
  $ "LemonData.MedianDemands" []
 ENDIF;

    END
    UUID "{347fb9ef-9b26-4db8-bfb3-f3d4abe582a5}";;

    RULE                 "Irrigation Release";
    DESCRIPTION          "";
    ACTIVE               FALSE;
    RULE_EXEC_CONSTRAINT NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "GetRunCycleIndex"(  ) == 1.00000000;
  NAMES_COLOR  "#00aa00";
    NOTES                "";
    BEGIN

      $ "Lemon Reservoir.Outflow" [] := IF ( "Lemon Irrigation Season"(  ) AND $ "Lemon Reservoir.Outflow" [] < $ "LemonData.Downstream Demand" [] )
 THEN
  $ "LemonData.Downstream Demand" []
 ENDIF;

    END
    UUID "{0ed23e79-7854-463d-bf43-967c7b7c74e5}";;

    RULE                 "ShowDemandPercentages";
    DESCRIPTION          "";
    ACTIVE               FALSE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000 AND NOT "HasRuleFiredSuccessfully"( "Current Rule" ) AND @"t" == @"October 31";
  NAMES_COLOR  "#00aa00";
    NOTES                "";
    BEGIN

      $ "LemonData.DemandPercentages" [] := "Min"( 1.00000000, "SumFlowsToVolume"( $ "Lemon Reservoir.Outflow", @"24:00:00 May 1, Current Year", @"t" ) / "SumFlowsToVolume"( $ "LemonData.MedianDemands", @"24:00:00 May 1, Current Year", @"t" ) );

    END
    UUID "{0e5c892a-b124-4427-bfa0-b79a440230b0}";;

    RULE                 "SetDownstreamDemands";
    DESCRIPTION          "";
    ACTIVE               FALSE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000 AND NOT "HasRuleFiredSuccessfully"( "Current Rule" );
  NAMES_COLOR  "#00aa00";
    NOTES                "";
    BEGIN

      $ "LemonData.Downstream Demand" [] := IF ( @"t" == @"November 1" )
 THEN
  $ "LemonData.Downstream Demand" [@"t - 1"]
 ELSE
  IF ( "Lemon Irrigation Season"(  ) )
  THEN
   "Max"( IF ( "CalculateAvailableIrrigationVolume"( % "Lemon Reservoir", $ "Lemon Reservoir.Inflow", $ "Lemon Reservoir.Storage", $ "LemonData.MinEOYStorage", $ "Lemon Reservoir.Evaporation" ) > $ "LemonData.MedianDemandsVolRemaining" [] )
   THEN
    $ "LemonData.MedianDemands" []
   ELSE
    IF ( "CalculateAvailableIrrigationVolume"( % "Lemon Reservoir", $ "Lemon Reservoir.Inflow", $ "Lemon Reservoir.Storage", $ "LemonData.MinEOYStorage", $ "Lemon Reservoir.Evaporation" ) <= $ "LemonData.MedianDemandsVolRemaining" [] )
    THEN
     "CalculateAvailableIrrigationVolume"( % "Lemon Reservoir", $ "Lemon Reservoir.Inflow", $ "Lemon Reservoir.Storage", $ "LemonData.MinEOYStorage", $ "Lemon Reservoir.Evaporation" ) / $ "LemonData.MedianDemandsVolRemaining" [] * $ "LemonData.MedianDemands" []
    ELSE
     1.00000000 "cfs"
    ENDIF
   ENDIF, 1.00000000 "cfs" )
  ELSE
   1.00000000 "cfs"
  ENDIF
 ENDIF;

    END
    UUID "{6ae66d11-6404-40f5-89a1-2bc7c90b8fb9}";;

    RULE                 "MinRelease_Winter";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "GetRunCycleIndex"(  ) == 1.00000000 AND @"t" <= @"24:00:00 October 1, 2023";
  NAMES_COLOR  "#ff0000";
    NOTES                "";
    BEGIN

      $ "Lemon Reservoir.Outflow" [] := 6.00000000 "cfs";

    END
    UUID "{5a181fc1-d6be-4058-ab9f-31099803a3ba}";;

    RULE                 "Minimum Release";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Lemon Reservoir.Outflow" [] := $ "LemonData.MinimumRelease" [];

    END
    UUID "{f067e870-ffbd-4caf-9b3e-922889bb13f4}";;

  END
  UUID "{2cb5a01d-6725-44ce-8e7d-2e7d661fd388}";;

  POLICY_GROUP   "1 Cycle- Vallecito Rules";
  DESCRIPTION    "";
  ACTIVE         TRUE;
  NAMES_COLOR  "#0055ff";
  NOTES          "";
  BEGIN

    RULE                 "KnownRelease";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Vallecito Reservoir.Outflow" [] := IF ( NOT IsNaN $ "VallecitoData.KnownRelease" [] )
 THEN
  $ "VallecitoData.KnownRelease" []
 ENDIF;

    END
    UUID "{5e649488-334b-4500-97a9-a704f685f4f3}";;

    RULE                 "MaxControlledRelease";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Vallecito Reservoir.Outflow" [] := IF ( $ "Vallecito Reservoir.Outflow" [] > $ "VallecitoData.MaxOutletWorksRelease" [] )
 THEN
  $ "VallecitoData.MaxOutletWorksRelease" []
 ENDIF;

    END
    UUID "{137252b0-a73f-49ef-84fa-affb9db7f520}";;

    RULE                 "MaxStorageFill";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Vallecito Reservoir.Outflow" [] := IF ( $ "Vallecito Reservoir.Storage" [] > $ "VallecitoData.MaxStorage" [] )
 THEN
  "VolumeToFlow"( $ "Vallecito Reservoir.Storage" [] - $ "VallecitoData.MaxStorage" [], @"t" ) + $ "Vallecito Reservoir.Outflow" []
 ENDIF;

    END
    UUID "{b355b2a9-05f9-4346-929e-689a9b7f4d61}";;

    RULE                 "MaxSafeChannelRelease";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Vallecito Reservoir.Outflow" [] := IF ( $ "Vallecito Reservoir.Outflow" [] > $ "VallecitoData.Safe Channel Capacity" [] )
 THEN
  $ "VallecitoData.Safe Channel Capacity" []
 ENDIF;

    END
    UUID "{53ede911-0786-461c-bfcb-09580dd33d27}";;

    RULE                 "ReleaseSmoothing";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Vallecito Reservoir.Outflow" [] := IF ( $ "Vallecito Reservoir.Outflow" [] < $ "Vallecito Reservoir.Outflow" [@"t - 1"] AND $ "Vallecito Reservoir.Storage" [@"t - 1"] / $ "VallecitoData.FloodControlStorageLimit" [@"t - 1"] >= $ "VallecitoData.DownwardSmoothingACE_ResetValue" [] )
 THEN
  $ "Vallecito Reservoir.Outflow" [@"t - 1"]
 ENDIF;

    END
    UUID "{2106e706-e2c1-4632-a1ae-7c30c136577c}";;

    RULE                 "FloodControlLimits";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Vallecito Reservoir.Outflow" [] := IF ( @"t" >= @"March 1" AND @"t" < @"August 1" AND $ "Vallecito Reservoir.Storage" [] > $ "VallecitoData.FloodControlStorageLimit" [] * $ "VallecitoData.PercentofACE_Flood_Control_Limit" [] )
 THEN
  "VolumeToFlow"( $ "Vallecito Reservoir.Storage" [] - ( $ "VallecitoData.FloodControlStorageLimit" [] * $ "VallecitoData.PercentofACE_Flood_Control_Limit" [] ), @"t" ) + $ "Vallecito Reservoir.Outflow" []
 ENDIF;

    END
    UUID "{e796f2c6-9390-436e-ba9f-f4d26fb4b579}";;

    RULE                 "SetFloodControlStorageLimit";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "VallecitoData.FloodControlStorageLimit" [] := IF ( @"t" >= @"March 1" AND @"t" <= @"July 31" )
 THEN
  "TableInterpolation3D"( $ "VallecitoData.Flood Control Table", 0.00000000, "GetDayOfYear"( @"t" ), 1.00000000, "Remaining Spring Runoff Volume"( % "Vallecito Reservoir" ), 2.00000000, @"t" )
 ENDIF;

    END
    UUID "{aff7bdb0-d7c1-4509-8b03-0933a7ab0144}";;

    RULE                 "IrrigationPondFilling";
    DESCRIPTION          "Using Lemon's pond filling season. ";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Vallecito Reservoir.Outflow" [] := IF ( "LemonPondFillingSeason"(  ) AND $ "Vallecito Reservoir.Outflow" [] < 100.00000000 "cfs" )
 THEN
  100.00000000 "cfs"
 ENDIF;

    END
    UUID "{df8ba994-59da-4070-94a6-96d4164be833}";;

    RULE                 "SetRemainingSpringRunnoff";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "VallecitoData.RemainingSpringRunoff" [] := "Remaining Spring Runoff Volume"( % "Vallecito Reservoir" );

    END
    UUID "{ad65d5fb-670e-4055-8220-281986e85044}";;

    RULE                 "PostPeakSmoothing";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Vallecito Reservoir.Outflow" [] := IF ( "PostPeakSmoothingPeriod"(  ) )
 THEN
  "Max"( "VolumeToFlow"( ( ( $ "Vallecito Reservoir.Storage" [] + "FlowToVolume"( $ "Vallecito Reservoir.Outflow" [], @"t" ) ) + "Remaining Post Peak Inflow Volume"(  ) - $ "VallecitoData.MaxWinterStorage" [] ) / ( "GetJulianDate"( @"24:00:00 November 1, Current Year" ) - "GetJulianDate"( @"t" ) ), @"t" ), $ "Vallecito Reservoir.Outflow" [] )
 ENDIF;

    END
    UUID "{a1adcabb-ea44-4c03-8eb2-cfaa840b6387}";;

    RULE                 "Deadpool";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "Vallecito Reservoir.Outflow" [] := IF ( $ "Vallecito Reservoir.Storage" [] < $ "VallecitoData.MinEOYStorage" [] )
 THEN
  $ "VallecitoData.MinimumRelease" []
 ENDIF;

    END
    UUID "{261117db-eb4b-45df-9a6f-5a33bcbafee7}";;

    RULE                 "Irrigation Release";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000 AND NOT "HasRuleFiredSuccessfully"( "Current Rule" );
    NOTES                "";
    BEGIN

      $ "Vallecito Reservoir.Outflow" [] := IF ( "Vallecito Irrigation Season"(  ) AND $ "Vallecito Reservoir.Outflow" [] < $ "VallecitoData.Downstream Demand" [] )
 THEN
  $ "VallecitoData.Downstream Demand" []
 ENDIF;

    END
    UUID "{d40b52d7-43ba-4ec3-aabd-13d154b2d9f8}";;

    RULE                 "ShowDemandPercentages";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000 AND NOT "HasRuleFiredSuccessfully"( "Current Rule" ) AND @"t" == @"October 31";
    NOTES                "";
    BEGIN

      $ "VallecitoData.DemandPercentages" [] := "Min"( 1.00000000, "SumFlowsToVolume"( $ "Vallecito Reservoir.Outflow", @"24:00:00 May 9, Current Year", @"t" ) / "SumFlowsToVolume"( $ "VallecitoData.MedianDemands", @"24:00:00 May 9, Current Year", @"t" ) );

    END
    UUID "{959fbe3c-2803-48e0-aa02-525baafdccc4}";;

    RULE                 "SetDownstreamDemands";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000 AND NOT "HasRuleFiredSuccessfully"( "Current Rule" );
    NOTES                "";
    BEGIN

      $ "VallecitoData.Downstream Demand" [] := IF ( @"t" == @"November 1" )
 THEN
  $ "VallecitoData.Downstream Demand" [@"t - 1"]
 ELSE
  IF ( "Vallecito Irrigation Season"(  ) )
  THEN
   "Max"( IF ( "CalculateAvailableIrrigationVolume"( % "Vallecito Reservoir", $ "Vallecito Reservoir.Inflow", $ "Vallecito Reservoir.Storage", $ "VallecitoData.MinEOYStorage", $ "Vallecito Reservoir.Evaporation" ) > $ "VallecitoData.MedianDemandsVolRemaining" [] )
   THEN
    $ "VallecitoData.MedianDemands" []
   ELSE
    IF ( "CalculateAvailableIrrigationVolume"( % "Vallecito Reservoir", $ "Vallecito Reservoir.Inflow", $ "Vallecito Reservoir.Storage", $ "VallecitoData.MinEOYStorage", $ "Vallecito Reservoir.Evaporation" ) <= $ "VallecitoData.MedianDemandsVolRemaining" [] )
    THEN
     "CalculateAvailableIrrigationVolume"( % "Vallecito Reservoir", $ "Vallecito Reservoir.Inflow", $ "Vallecito Reservoir.Storage", $ "VallecitoData.MinEOYStorage", $ "Vallecito Reservoir.Evaporation" ) / $ "VallecitoData.MedianDemandsVolRemaining" [] * $ "VallecitoData.MedianDemands" []
    ELSE
     1.00000000 "cfs"
    ENDIF
   ENDIF, 1.00000000 "cfs" )
  ELSE
   1.00000000 "cfs"
  ENDIF
 ENDIF;

    END
    UUID "{802d2d47-a098-4d1d-9559-673cc19d978f}";;

    RULE                 "WinterStorageLimit";
    DESCRIPTION          "Set release such that reservoir storage is less than or equal to 77,000 af.  This is to keep reservoir elevation below the bottom of radial gates during icing season.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Vallecito Reservoir.Outflow" [] := IF ( "Winter Storage Season"(  ) AND $ "Vallecito Reservoir.Storage" [] > $ "VallecitoData.MaxWinterStorage" [] )
 THEN
  "Max"( "VolumeToFlow"( $ "Vallecito Reservoir.Storage" [] + "FlowToVolume"( $ "Vallecito Reservoir.Outflow" [], @"t" ) - $ "VallecitoData.MaxWinterStorage" [], @"t" ), $ "Vallecito Reservoir.Outflow" [] )
 ENDIF;

    END
    UUID "{b37fff0b-1ff5-4d6c-afe5-134d6dc164d2}";;

    RULE                 "Minimum Release - CWCB Donation Agreement";
    DESCRIPTION          "";
    ACTIVE               FALSE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000 AND "CWCB Donation Agreement Season"(  );
    NOTES                "";
    BEGIN

      $ "Vallecito Reservoir.Outflow" [] := IF ( $ "Vallecito Reservoir.Storage" [@"t - 1"] <= 60000.00000000 "acre-ft" )
 THEN
  5.00000000 "cfs"
 ELSE
  IF ( $ "Vallecito Reservoir.Storage" [@"t - 1"] > 60000.00000000 "acre-ft" )
  THEN
   25.00000000 "cfs"
  ELSE
   IF ( $ "Vallecito Reservoir.Storage" [@"t - 1"] > 100000.00000000 "acre-ft" )
   THEN
    50.00000000 "cfs"
   ELSE
    7.00000000 "cfs"
   ENDIF
  ENDIF
 ENDIF;

    END
    UUID "{b510eb41-7899-4388-a222-aa5dd963ab3f}";;

    RULE                 "SetMinRelease";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
  NAMES_COLOR  "#0055ff";
    NOTES                "";
    BEGIN

      $ "Vallecito Reservoir.Outflow" [] := 5.00000000 "cfs";

    END
    UUID "{37bc55ba-eed8-4312-8d24-03c7748beca9}";;

  END
  UUID "{f97454dd-7315-4849-93b7-36f3de14d2c5}";;

  POLICY_GROUP   "1 Cycle- Set Losses";
  DESCRIPTION    "";
  ACTIVE         TRUE;
  NAMES_COLOR  "#0055ff";
  NOTES          "";
  BEGIN

    RULE                 "Set Local Inflows";
    DESCRIPTION          "Daily gainloss is a calculated gage-to-gage statistical loss. Choose statistical for entire model run in SWITCHES object. <br>Local inflows will never make river go less than 0. This is recorded in the reach &quot;unidentified loss&quot;.<br>Yes.<br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000 AND $ "SWITCHES.UseNewGainLosses" [] == 0.00000000;
    NOTES                "";
    BEGIN

      $ "Animas River.Local Inflow" [] := $ "Animas River.DailyGainLoss" [@"t", $ "SWITCHES.ReachLossPercentile" []];

      $ "SJAF.Local Inflow" [] := $ "SJAF.DailyGainLoss" [@"t", $ "SWITCHES.ReachLossPercentile" []];

      $ "SJFS.Local Inflow" [] := $ "SJFS.DailyGainLoss" [@"t", $ "SWITCHES.ReachLossPercentile" []];

      $ "SJS4.Local Inflow" [] := $ "SJS4.DailyGainLoss" [@"t", $ "SWITCHES.ReachLossPercentile" []];

      $ "SJ4B.Local Inflow" [] := $ "SJ4B.DailyGainLoss" [@"t", $ "SWITCHES.ReachLossPercentile" []];

      $ "Pine River.Local Inflow" [] := $ "Pine River.DailyGainLoss" [@"t", $ "SWITCHES.ReachLossPercentile" []];

      $ "Florida River.Local Inflow" [] := $ "Florida River.DailyGainLoss" [@"t", $ "SWITCHES.ReachLossPercentile" []];

    END
    UUID "{3794d3c6-8046-4668-9169-57935dcb2e4b}";;

    RULE                 "Set Local Inflows- Original";
    DESCRIPTION          "Daily gainloss is a calculated gage-to-gage statistical loss. Choose statistical for entire model run in SWITCHES object. <br>Local inflows will never make river go less than 0. This is recorded in the reach &quot;unidentified loss&quot;.<br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000 AND $ "SWITCHES.UseNewGainLosses" [] == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Animas River.Local Inflow" [] := $ "Animas River.DailyGainLoss" [@"t", $ "SWITCHES.ReachLossPercentile" []];

      $ "SJAF.Local Inflow" [] := $ "SJAF.DailyGainLoss" [@"t", $ "SWITCHES.ReachLossPercentile" []];

      $ "SJFS.Local Inflow" [] := $ "SJFS.DailyGainLoss" [@"t", $ "SWITCHES.ReachLossPercentile" []];

      $ "SJS4.Local Inflow" [] := $ "SJS4.DailyGainLoss" [@"t", $ "SWITCHES.ReachLossPercentile" []];

      $ "SJ4B.Local Inflow" [] := $ "SJ4B.DailyGainLoss" [@"t", $ "SWITCHES.ReachLossPercentile" []];

      $ "Pine River.Local Inflow" [] := $ "Pine River.DailyGainLoss" [@"t", $ "SWITCHES.ReachLossPercentile" []];

      $ "Florida River.Local Inflow" [] := $ "Florida River.DailyGainLoss" [@"t", $ "SWITCHES.ReachLossPercentile" []];

    END
    UUID "{f02dc506-0c84-487c-b80f-df746174f095}";;

    RULE                 "Set Local Inflows- Forecast Based";
    DESCRIPTION          "Daily gainloss is a calculated gage-to-gage statistical loss. Choose statistical for entire model run in SWITCHES object. <br>Local inflows will never make river go less than 0. This is recorded in the reach &quot;unidentified loss&quot;.<br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000 AND $ "SWITCHES.UseNewGainLosses" [] == 2.00000000;
    NOTES                "";
    BEGIN

    DESCRIPTION          "Use DRGC2 for forecast <br>";
      $ "Animas River.Local Inflow" [] := $ "Animas River.DailyGainLoss" [@"t", "Lookup Loss Percentile"( "DRGC2" )];

    DESCRIPTION          "Use NVRN5 <br>";
      $ "SJAF.Local Inflow" [] := $ "SJAF.DailyGainLoss" [@"t", "Lookup Loss Percentile"( "NVRN5" )];

      $ "SJFS.Local Inflow" [] := $ "SJFS.DailyGainLoss" [@"t", "Lookup Loss Percentile"( "NVRN5" )];

      $ "SJS4.Local Inflow" [] := $ "SJS4.DailyGainLoss" [@"t", "Lookup Loss Percentile"( "NVRN5" )];

      $ "SJ4B.Local Inflow" [] := $ "SJ4B.DailyGainLoss" [@"t", "Lookup Loss Percentile"( "NVRN5" )];

    DESCRIPTION          "Use LEMC2 for the forecast location <br>";
      $ "Pine River.Local Inflow" [] := $ "Pine River.DailyGainLoss" [@"t", "Lookup Loss Percentile"( "VCRC2" )];

    DESCRIPTION          "Use VCRC2 for the forecast location <br>";
      $ "Florida River.Local Inflow" [] := $ "Florida River.DailyGainLoss" [@"t", "Lookup Loss Percentile"( "LEMC2" )];

    DESCRIPTION          "Write out the percentile used <br>";
      $ "GainLossCalculations.ForecastPercentileNVRN5" [] := "Lookup Loss Percentile"( "NVRN5" );

      $ "GainLossCalculations.ForecastPercentileDRGC2" [] := "Lookup Loss Percentile"( "DRGC2" );

      $ "GainLossCalculations.ForecastPercentileVCRC2" [] := "Lookup Loss Percentile"( "VCRC2" );

      $ "GainLossCalculations.ForecastPercentileLEMC2" [] := "Lookup Loss Percentile"( "LEMC2" );

    END
    UUID "{9d022804-c6be-41c2-b1fb-fcf0550f36df}";;

    RULE                 "SetShortageLocalInflow";
    DESCRIPTION          "This will bound the Animas Losses between a max of 775 cfs and a min of -500 cfs. Based on LOSSES_V.xlsm.<br>This is just a max and min observed for the whole year 1999-2013.  Next step would be put into a table by month of year.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Shortage.Local Inflow" [] := 0.00000000 "cfs";

    END
    UUID "{e80363d2-0af0-4df2-b3ee-7d3daf6a32e3}";;

    RULE                 "Set Shortage Inflow";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Shortage.Inflow" [] := 0.00000000 "cfs";

    END
    UUID "{59abde6f-8385-44c3-ad3f-dbad15263f0f}";;

    RULE                 "Set SJC Diversions";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "San Juan Chama Project.Diversion" [] := $ "San Juan Chama Project.Diversion Requested" [];

    END
    UUID "{d7d49521-282a-45f8-bb97-6962a6325af4}";;

    RULE                 "Set NIIP Diversions";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "NIIP.Diversion" [] := $ "NIIP.Diversion Requested" [];

    END
    UUID "{248987d0-4dc9-44b0-9f0c-e5eb57a8680d}";;

    RULE                 "Manual NIIP_Shortage";
    DESCRIPTION          "Reduces NIIP diversion during a shortage in the timeframe specified. Use proportional estimates to reduce NIIP by an exact amount. THen resolve the remainder through the downstream release.<br><br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000 AND $ "SWITCHES.Shortage" [] == 1.00000000;
  NAMES_COLOR  "#00007f";
    NOTES                "";
    BEGIN

      $ "NIIP.Diversion Requested" [] := $ "NIIP.StaticYearlyNIIPvalues_SHORTAGE" [];

    END
    UUID "{80d5883a-26b5-4abb-9687-4f4f7d74d748}";;

    RULE                 "MANUAL NIIP";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "NIIP.Diversion Requested" [] := $ "NIIP.StaticYearlyNIIPvalues" [];

    END
    UUID "{7dc85bdb-014e-48dc-a011-895e75d81613}";;

  END
  UUID "{fea7b1ea-ac7c-40e3-8e8a-5d0d6941bd26}";;

  POLICY_GROUP   "1 Cycle - OFFICIAL INFLOW FORECASTS";
  DESCRIPTION    "";
  ACTIVE         TRUE;
  NAMES_COLOR  "#ffaa00";
  NOTES          "";
  BEGIN

    RULE                 "Set SJC Diversion";
    DESCRIPTION          "Daily SJC diversion is directly related to the daily MUI flows. This correlation was made by comparing historic Azotea flows and MUI flows from 10/1/1990 - 8/2/2022  We are assuming on a daily basis that Azotea will pull whatever is available. up to max of 950 cfs  C:\Users\sbehery\OneDrive - DOI\RIVERWARE MODELS\SAN JUAN BASIN OPERATIONAL MODEL\San Juan Chama.csv";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT @"t" == @"Start Timestep" AND "GetRunCycleIndex"(  ) == 1.00000000 AND $ "SWITCHES.MODE" [] == 0.00000000;
    NOTES                "";
    BEGIN

      FOREACH (DATETIME date IN @"Start Timestep" TO @"Finish Timestep") DO
            $ "San Juan Chama Project.Diversion Requested" [date] := "Max"( "Min"( ( $ "NavajoData.CBRFC Inflow" [date] - 419.40000000 "cfs" ) / 6.60830000 "cfs" * 1.00000000 "cfs", 950.00000000 "cfs" ), 0.00000000 "cfs" );

      ENDFOREACH;

    END
    UUID "{19d72f34-166d-4f94-a8c4-a0ffb50b88b1}";;

    RULE                 "Set Month 1 Inflows";
    DESCRIPTION          "Do not use execution constraints. Inflows must be input every cycle (why?) or model will not execute completely.<br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT ( NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "GetRunCycleIndex"(  ) == 1.00000000 ) AND $ "SWITCHES.MODE" [] == 0.00000000;
    NOTES                "";
    BEGIN

      $ "Vallecito Reservoir.Inflow" [] := IF ( NOT IsNaN $ "INFLOW SO FAR THIS MONTH.Vallecito" [] )
 THEN
  $ "INFLOW SO FAR THIS MONTH.Vallecito" []
 ENDIF;

      $ "Lemon Reservoir.Inflow" [] := IF ( NOT IsNaN $ "INFLOW SO FAR THIS MONTH.Lemon" [] )
 THEN
  $ "INFLOW SO FAR THIS MONTH.Lemon" []
 ENDIF;

      $ "NavajoData.CBRFC Inflow" [] := IF ( NOT IsNaN $ "INFLOW SO FAR THIS MONTH.Navajo" [] )
 THEN
  $ "INFLOW SO FAR THIS MONTH.Navajo" []
 ENDIF;

      $ "Animas abv Nighthorse.Inflow" [] := IF ( NOT IsNaN $ "INFLOW SO FAR THIS MONTH.AnimasDur" [] )
 THEN
  $ "INFLOW SO FAR THIS MONTH.AnimasDur" []
 ENDIF;

    END
    UUID "{fe33a610-d6ff-4df2-8920-ca564b64c369}";;

    RULE                 "Set Inflows";
    DESCRIPTION          "Do not use execution constraints. Inflows must be input every cycle (why?) or model will not execute completely.<br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT @"t" == @"Start Timestep" AND ( NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "GetRunCycleIndex"(  ) == 1.00000000 ) AND $ "SWITCHES.MODE" [] == 0.00000000;
    NOTES                "";
    BEGIN

      FOREACH (DATETIME date IN @"Start Timestep" TO @"Finish Timestep") DO
            $ "Vallecito Reservoir.Inflow" [date] := $ "InflowDisagg.InflowForecastVallecito" [date];

            $ "NavajoData.CBRFC Inflow" [date] := $ "InflowDisagg.InflowForecastNavajo" [date];

            $ "Lemon Reservoir.Inflow" [date] := $ "InflowDisagg.InflowForecastLemon" [date];

            $ "Animas abv Nighthorse.Inflow" [date] := $ "InflowDisagg.InflowForecastAnimas" [date];

      ENDFOREACH;

    END
    UUID "{61f48508-3132-4a38-9bac-0bfd69fb1ff4}";;

    RULE                 "1 Cycle - Write Scaled Forecast";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000 AND @"t" == @"Start Timestep" AND $ "SWITCHES.MODE" [] == 0.00000000;
    NOTES                "";
    BEGIN

      FOREACH (STRING forecastLocation IN { "Vallecito" , "Lemon" , "Animas" , "Navajo" }) DO
          DESCRIPTION          "Loop over all daily timesteps in the run. <br>";
      FOREACH (DATETIME date IN @"Start Timestep" TO @"Finish Timestep") DO
          DESCRIPTION          "Get the date at the end of that month. <br>";
      WITH_STATEMENT (DATETIME endOfMonth = "CompletePartialDate"( @"Max DayOfMonth", date )) DO
          DESCRIPTION          "Find the ratio of the CBRFC forecast volume to the computed forecast over this month. <br>";
      WITH_STATEMENT (NUMERIC ratio = % "CBRFC" & ( "MapForecastLocationToCode"( forecastLocation ) CONCAT "CBRFC Forecast Type"(  ) ) [endOfMonth] / "SumFlowsToVolume"( % "InflowDisagg" & ( "InflowForecastUnscaled" CONCAT forecastLocation ), "CompletePartialDate"( @"Min DayOfMonth", date ), endOfMonth )) DO
          DESCRIPTION          "Set the forecast by multiplying the unscaled forecast by the scaling factor. <br>";
      % "InflowDisagg" & ( "InflowForecast" CONCAT forecastLocation ) [date] := % "InflowDisagg" & ( "InflowForecastUnscaled" CONCAT forecastLocation ) [date] * ratio;

      END_WITH_STATEMENT;

      END_WITH_STATEMENT;

      ENDFOREACH;

      ENDFOREACH;

    END
    UUID "{7c63800f-578b-464c-89c5-c8a5fb62409a}";;

    RULE                 "1 Cycle - Write Forecast as Average of Nearest Years";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000 AND @"t" == @"Start Timestep" AND $ "SWITCHES.MODE" [] == 0.00000000;
    NOTES                "";
    BEGIN

      FOREACH (STRING forecastLocation IN { "Vallecito" , "Lemon" , "Animas" , "Navajo" }) DO
          DESCRIPTION          "Loop over all daily timesteps <br>";
      FOREACH (DATETIME date IN @"Start Timestep" TO @"Finish Timestep") DO
          DESCRIPTION          "Get the list of nearest years <br>";
      WITH_STATEMENT (LIST NearestYears = FOR ( NUMERIC num IN "GetNumbers"( 1.00000000, $ "InflowDisagg.NumberOfSimilarYears" [], 1.00000000 ) ) WITH LIST result = {  } DO
  APPEND % "InflowDisagg" & ( "HistoricalYearsSelected" CONCAT forecastLocation ) ["CompletePartialDate"( @"24:00:00 Max DayOfMonth", date ), num - 1.00000000] ONTO result
 ENDFOR) DO
          DESCRIPTION          "Average the flows for this day (i.e. Aug 13) using N values from the historical years; e.g. Aug 13, <br>1983, Aug 13 1989, Aug 13, 2015. <br>";
      % "InflowDisagg" & ( "InflowForecastUnscaled" CONCAT forecastLocation ) [date] := FOR ( NUMERIC year IN NearestYears ) STAT_AVE
  % "HISTORIC" & ( forecastLocation CONCAT "DailyInflow" ) ["CompletePartialDate"( "NumberToYear"( year ), IF ( ( date == @"February 29" ) COMMENTED_BY "Need special logic on leap day <br>" )
  THEN
   date - 1.00000000 "day"
  ELSE
   date
  ENDIF )]
 ENDFOR;

      END_WITH_STATEMENT;

      ENDFOREACH;

      ENDFOREACH;

    END
    UUID "{dfc10dff-fb09-4bf8-bcf1-b217c0c98d93}";;

    RULE                 "1 Cycle - Find Nearest Years";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000 AND @"t" == @"Start Timestep" AND $ "SWITCHES.MODE" [] == 0.00000000;
    NOTES                "";
    BEGIN

      FOREACH (STRING forecastLocation IN { "Vallecito" , "Lemon" , "Animas" , "Navajo" }) DO
            FOREACH (DATETIME givenMonth IN "GetDates"( "OffsetDate"( @"Start Timestep - 1", 1.00000000, "1 Months" ), @"Finish Timestep", "1 Months" ) COMMENTED_BY "Get a List of all the months in the run <br>&lcub;Aug 31, 2014, Sep 30, 2014,...&rcub; <br>") DO
            WITH_STATEMENT (LIST MonthsAndYearsForThisMonth = FOR ( DATETIME month IN "GetDates"( @"24:00:00 October 31, 1980", @"24:00:00 September 30, 2020", "1 Months" ) ) WITH LIST result = {  } DO
  IF ( "GetMonth"( month ) == "GetMonth"( givenMonth ) )
  THEN
   APPEND { month , "GetYear"( month ) } ONTO result
  ELSE
   result
  ENDIF
 ENDFOR COMMENTED_BY "Get a list of all of the months that match the given Month<br>&lcub;Aug 31, 2015, 2015&rcub;  <br>") DO
          DESCRIPTION          "Get a sorted list of the forecast location volume and corresponding year<br>&lcub;&lcub;1000AF, 2013&rcub; , &lcub;1200AF, 1985&rcub;, ...&rcub; <br>";
      WITH_STATEMENT (LIST SortedListOfYearsVolumes = "Sort"( FOR ( LIST monthYear IN MonthsAndYearsForThisMonth ) WITH LIST result = {  } DO
  APPEND { % "HISTORIC" & ( forecastLocation CONCAT "MonthlyInflow" ) [GET @INDEX 0.00000000 FROM monthYear] , GET @INDEX 1.00000000 FROM monthYear } ONTO result
 ENDFOR )) DO
          DESCRIPTION          "Find the N nearest years based on the above list and the forecast volume. <br>";
      WITH_STATEMENT (LIST nearestYears = "GetNNearestYears"( SortedListOfYearsVolumes, givenMonth, forecastLocation, "CBRFC Forecast Type"(  ) )) DO
            FOREACH (NUMERIC num IN "GetNumbers"( 1.00000000, $ "InflowDisagg.NumberOfSimilarYears" [], 1.00000000 )) DO
          DESCRIPTION          "Loop over the number of nearest years and set the nearest years (as numbers) to an Agg slot  <br>";
      % "InflowDisagg" & ( "HistoricalYearsSelected" CONCAT forecastLocation ) [givenMonth, num - 1.00000000] := GET @INDEX num - 1.00000000 FROM nearestYears;

      ENDFOREACH;

      END_WITH_STATEMENT;

      END_WITH_STATEMENT;

      END_WITH_STATEMENT;

      ENDFOREACH;

      ENDFOREACH;

    END
    UUID "{1fa586e5-0daa-4bc2-90bf-a547f5acee02}";;

  END
  UUID "{78a749a9-234b-45d7-92ba-61e2396cb4e4}";;

  POLICY_GROUP   "1 Cycle - MRM INFLOW FORECASTS";
  DESCRIPTION    "";
  ACTIVE         TRUE;
  NAMES_COLOR  "#ffaa00";
  NOTES          "";
  BEGIN

    RULE                 "Set SJC Diversion";
    DESCRIPTION          "Daily SJC diversion is directly related to the daily MUI flows. This correlation was made by comparing historic Azotea flows and MUI flows from 10/1/1980 - 8/31/2018.  We are assuming on a daily basis that Azotea will pull whatever is available. ";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT @"t" == @"Start Timestep" AND "GetRunCycleIndex"(  ) == 1.00000000 AND $ "SWITCHES.MODE" [] == 1.00000000;
    NOTES                "";
    BEGIN

      FOREACH (DATETIME date IN @"Start Timestep" TO @"Finish Timestep") DO
            $ "San Juan Chama Project.Diversion Requested" [date] := "Max"( "Min"( ( $ "NavajoData.CBRFC Inflow" [date] - 419.40000000 "cfs" ) / 6.60830000 "cfs" * 1.00000000 "cfs", 950.00000000 "cfs" ), 0.00000000 "cfs" );

      ENDFOREACH;

    END
    UUID "{ebd24d1c-ffdf-4b4b-9f7b-2ace173ca1ee}";;

    RULE                 "Set Inflows";
    DESCRIPTION          "Do not use execution constraints. Inflows must be input every cycle (why?) or model will not execute completely.<br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT @"t" == @"Start Timestep" AND $ "SWITCHES.MODE" [] == 1.00000000;
    NOTES                "";
    BEGIN

      FOREACH (DATETIME date IN @"Start Timestep" TO @"Finish Timestep") DO
            $ "Vallecito Reservoir.Inflow" [date] := $ "MRM Data.TraceVCRC2" [date];

            $ "NavajoData.CBRFC Inflow" [date] := $ "MRM Data.TraceNVRN5" [date];

            $ "Lemon Reservoir.Inflow" [date] := $ "MRM Data.TraceLEMC2" [date];

            $ "Animas abv Nighthorse.Inflow" [date] := $ "MRM Data.TraceDRGC2" [date];

      ENDFOREACH;

    END
    UUID "{02e18762-050f-4192-8434-b0bce5300e77}";;

  END
  UUID "{c9ac1b61-8a83-4a15-9649-95c98493fd9d}";;

  POLICY_GROUP   "Archived Rules";
  DESCRIPTION    "";
  ACTIVE         TRUE;
  NOTES          "";
  BEGIN

    RULE                 "SHORTAGE - Reduced TBF through Release this year";
    DESCRIPTION          "Reduces the previously calculated release to meet min 500 cfs by some increment for the time period specified. First do NIIP to reduce them by a specific amount during high season. Then do rest from here during same timeframe (summer) when we aren't already at 250.<br><br><br>";
    ACTIVE               FALSE;
    RULE_EXEC_CONSTRAINT NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "GetRunCycleIndex"(  ) == 3.00000000 AND ( @"t" > @"24:00:00 July 1, 2022" AND @"t" < @"24:00:00 December 31, 2022" ) AND $ "SWITCHES.Shortage" [] == 1.00000000;
  NAMES_COLOR  "#00007f";
    NOTES                "";
    BEGIN

      $ "Navajo Reservoir.Release" [] := "Max"( $ "Navajo Reservoir.Release" [] - $ "Shortage.ReleaseReduction" [], 250.00000000 "cfs" );

    END
    UUID "{57a944ac-dd79-47c3-8606-a2578adafdcf}";;

    RULE                 "SHORTAGE - Reduced TBF through Release next year";
    DESCRIPTION          "Reduces the previously calculated release to meet min 500 cfs by some increment for the time period specified. First do NIIP to reduce them by a specific amount during high season. Then do rest from here during same timeframe (summer) when we aren't already at 250.<br><br><br>";
    ACTIVE               FALSE;
    RULE_EXEC_CONSTRAINT NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "GetRunCycleIndex"(  ) == 3.00000000 AND ( @"t" > @"24:00:00 December 31, 2022" AND @"t" < @"24:00:00 December 31, 2023" ) AND $ "SWITCHES.Shortage" [] == 1.00000000;
  NAMES_COLOR  "#00007f";
    NOTES                "";
    BEGIN

      $ "Navajo Reservoir.Release" [] := "Max"( $ "Navajo Reservoir.Release" [] - $ "Shortage.ReleaseReduction_nextyear" [], 250.00000000 "cfs" );

    END
    UUID "{5b8757bb-8a33-4e21-bef1-948f1db44791}";;

    RULE                 "DROA 2022 Risk Analysis Contribution Baseflows";
    DESCRIPTION          "For DROA scenarios. Modify with scenario. This is for baseflows.<br><br>";
    ACTIVE               FALSE;
    RULE_EXEC_CONSTRAINT NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "GetRunCycleIndex"(  ) == 3.00000000 AND @"t" < @"24:00:00 January 1, 2023" AND @"t" > @"24:00:00 October 31, 2022";
  NAMES_COLOR  "#0055ff";
    NOTES                "";
    BEGIN

      $ "Navajo Reservoir.Release" [] := $ "Navajo Reservoir.Release" [] + 407.00000000 "cfs";

    END
    UUID "{05ec0343-8700-44e6-aa5c-433737b4e2df}";;

    RULE                 "Set NIIP Diversions -MANUAL SHORTED next CY";
    DESCRIPTION          "Reduces NIIP diversion during a shortage in the timeframe specified. Use proportional estimates to reduce NIIP by an exact amount. THen resolve the remainder through the downstream release.<br><br>";
    ACTIVE               FALSE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000 AND ( @"t" > @"24:00:00 January 1, 2023" AND @"t" < @"24:00:00 December 31, 2023" ) AND $ "SWITCHES.Shortage" [] == 1.00000000;
  NAMES_COLOR  "#00007f";
    NOTES                "";
    BEGIN

      $ "NIIP.Diversion Requested" [] := "Max"( $ "NIIP.StaticYearlyNIIPvalues" [] - $ "Shortage.NIIP Reduction_next year" [], 0.00000000 "cfs" );

    END
    UUID "{c6d2fd5c-ce72-4a90-b585-afa153545ff0}";;

    RULE                 "RecordShortageAndDemands";
    DESCRIPTION          "Whole demands from Cycle 3 is the volumetric addition of Navajo Release, NIIP, and San Juan-Chama, MINUS the 250cfs minimum daily release from Navajo in acre-feet.  This ensures we are adding together only volumes that are available to short.<br>";
    ACTIVE               FALSE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 3.00000000 AND $ "SWITCHES.Magic Water" [] == 1.00000000;
    NOTES                "";
    BEGIN

      $ "ShortageData.ShortageVolumeToRecover" [] := "FlowToVolume"( $ "Shortage.Local Inflow" [], @"t" );

      $ "ShortageData.WholeDemandsFromCycle3" [] := "FlowToVolume"( $ "Navajo Reservoir.Release" [], @"t" ) + "FlowToVolume"( $ "NIIP.Diversion" [], @"t" ) + "FlowToVolume"( $ "San Juan Chama Project.Diversion" [], @"t" ) - 495.86776800 "acre-feet";

      $ "ShortageData.NavajoReleasesCycle3" [] := $ "Navajo Reservoir.Release" [];

    END
    UUID "{e33e195d-f11a-420e-817d-fae043fe96b5}";;

    RULE                 "SetSPRbyPeakDays";
    DESCRIPTION          "When SPR has begun (when very close to SPR time) , the SPR must be manually input here-- this rule should be turned off and the SPR being used should be input into the &quot;NavajoData.KnownReleasePattern&quot; slot.";
    ACTIVE               FALSE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 3.00000000 AND NOT "HasRuleFiredSuccessfully"( "ThisRule" );
  NAMES_COLOR  "#00aa00";
    NOTES                "";
    BEGIN

      $ "NavajoData.Cycle3SpringPeakRelease" [] := IF ( "SpringPeakReleaseSeason"(  ) )
 THEN
  $ "NavajoData.SPRTables_7dayramp" [@"t", $ "NavajoData.Cycle3MaxDaysAtPeak" [@"t"]]
 ENDIF;

    END
    UUID "{e2b6c1fe-51ae-415c-b504-7ae1057aa089}";;

    RULE                 "Manual Maintenance Release";
    DESCRIPTION          "When SPR has begun (when very close to SPR time) , the SPR must be manually input here-- this rule should be turned off and the SPR being used should be input into the &quot;NavajoData.KnownReleasePattern&quot; slot.";
    ACTIVE               FALSE;
    RULE_EXEC_CONSTRAINT NOT "HasRuleFiredSuccessfully"( "ThisRule" ) AND "GetRunCycleIndex"(  ) == 3.00000000;
  NAMES_COLOR  "#aa55ff";
    NOTES                "";
    BEGIN

      $ "Navajo Reservoir.Release" [] := IF ( NOT IsNaN $ "NavajoData.ManualMaintenanceRelease" [] )
 THEN
  $ "NavajoData.ManualMaintenanceRelease" []
 ENDIF;

    END
    UUID "{9f7f1154-c8f9-4b55-91e8-d480753b4bfb}";;

    RULE                 "SetWinterRelease";
    DESCRIPTION          "";
    ACTIVE               FALSE;
    RULE_EXEC_CONSTRAINT "GetRunCycleIndex"(  ) == 1.00000000;
    NOTES                "";
    BEGIN

      $ "Vallecito Reservoir.Outflow" [] := IF ( "Winter Storage Season"(  ) )
 THEN
  "Max"( "VolumeToFlow"( ( ( $ "Vallecito Reservoir.Storage" [@"t - 1"] + "Remaining Winter Inflow Volume"( % "Vallecito Reservoir" ) ) - $ "VallecitoData.MaxWinterStorage" [] ) / "DaysUntilEndOfWinterStorage"(  ), @"t" ), $ "Vallecito Reservoir.Outflow" [] )
 ENDIF;

    END
    UUID "{45319a27-0899-4b74-88fa-431d555297da}";;

  END
  UUID "{7073a789-d8ef-439a-ae1a-08e65b321426}";;

  UTILITY_GROUP "Vallecito Functions";
  DESCRIPTION   "";
  ACTIVE        TRUE;
  NOTES          "";
  BEGIN

    FUNCTION       "Winter Storage Season" (  )
    RETURN_TYPE    BOOLEAN;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      @"t" > @"October 31" OR @"t" < @"March 1";

    END
    UUID "{fda531a5-a651-4be6-a2d8-280a1361d3f0}";;

    FUNCTION       "CWCB Donation Agreement Season" (  )
    RETURN_TYPE    BOOLEAN;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      @"t" > @"September 30" OR @"t" < @"May 10";

    END
    UUID "{b18eede1-56f3-4e5f-89c4-e7dbedd0bf1d}";;

    FUNCTION       "Vallecito Irrigation Season" (  )
    RETURN_TYPE    BOOLEAN;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      @"t" <= @"October 31" AND @"t" > @"May 9";

    END
    UUID "{9f89945a-845c-4518-839d-42e7f29142c9}";;

    FUNCTION       "DaysUntilEndOfWinterStorage" (  )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "This function calculates the number of days from the current timestep to March 1st (end of winter storage season) of the current Water Year.";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      IF ( "Winter Storage Season"(  ) AND @"t" > @"October 31" )
 THEN
  "GetJulianDate"( @"24:00:00 March 1, Next Year" ) - "GetJulianDate"( @"t" )
 ELSE
  IF ( "Winter Storage Season"(  ) AND @"t" < @"March 1" )
  THEN
   "GetJulianDate"( @"24:00:00 March 1, Current Year" ) - "GetJulianDate"( @"t" )
  ELSE
   0.00000000 "day"
  ENDIF
 ENDIF;

    END
    UUID "{60b5c8d1-9506-4908-9576-bd36162fef53}";;

    FUNCTION       "Remaining Winter Inflow Volume" ( OBJECT res )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      IF ( "Winter Storage Season"(  ) AND @"t" > @"October 31" )
 THEN
  "SumFlowsToVolume"( res & "Inflow", @"t", @"24:00:00 February Max DayOfMonth, Next Year" )
 ELSE
  IF ( "Winter Storage Season"(  ) AND @"t" < @"March 1" )
  THEN
   "SumFlowsToVolume"( res & "Inflow", @"t", @"24:00:00 February Max DayOfMonth, Current Year" )
  ELSE
   0.00000000 "acre-feet"
  ENDIF
 ENDIF;

    END
    UUID "{5d8d7f68-07d0-4bdc-8985-1f1808d4058f}";;

    FUNCTION       "Remaining Post Peak Inflow Volume" (  )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      IF ( "PostPeakSmoothingPeriod"(  ) )
 THEN
  "SumFlowsToVolume"( $ "Vallecito Reservoir.Inflow", @"t", @"24:00:00 October Max DayOfMonth, Current Year" )
 ELSE
  0.00000000 "acre-feet"
 ENDIF;

    END
    UUID "{1a5e7671-65c9-498e-9a48-c2f103eb0674}";;

    FUNCTION       "PostPeakSmoothingPeriod" (  )
    RETURN_TYPE    BOOLEAN;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      @"t" >= "NumberToDate"( $ "VallecitoData.PostPeakSmoothingBeginDate" [] ) AND @"t" < @"November 1";

    END
    UUID "{80f37187-5e2f-4dae-bb29-2d050b4a3bdf}";;

  END
  UUID "{fc173593-eeae-440d-ba7a-4e51de51f649}";;

  UTILITY_GROUP "Lemon Functions";
  DESCRIPTION   "";
  ACTIVE        TRUE;
  NOTES          "";
  BEGIN

    FUNCTION       "Lemon Irrigation Season" (  )
    RETURN_TYPE    BOOLEAN;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      @"t" <= @"October 31" AND @"t" > @"April 30";

    END
    UUID "{cd8ceb30-2ea4-4a90-a63e-d7a357d3409e}";;

    FUNCTION       "LemonPondFillingSeason" (  )
    RETURN_TYPE    BOOLEAN;
    SCALE_UNITS    "";
    DESCRIPTION    "John Set the dates Sept 2021 as Sept 27 - Oct 1 for 500 af which is about 50 cfs per day for those five days.";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      @"t" <= @"October 1" AND @"t" > @"September 26";

    END
    UUID "{0001d32e-d445-44f4-a87b-85377df28bdd}";;

  END
  UUID "{521b6ea0-1ca1-47a2-9fdf-494f1e2c1b13}";;

  UTILITY_GROUP "Nighthorse Functions";
  DESCRIPTION   "";
  ACTIVE        TRUE;
  NOTES          "";
  BEGIN

    FUNCTION       "PickStepPump" (  )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "This function returns the closest step pump to the value that was calculated in PumpingPerDay";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      "TableLookupDefaultTol"( $ "NighthorseData.StepPumps", 0.00000000, 0.00000000, "CalculateDailyFlow"(  ), @"t", TRUE );

    END
    UUID "{64d9fead-8c28-4dbf-8922-bedaee930116}";;

    FUNCTION       "ALP Pumping Season" (  )
    RETURN_TYPE    BOOLEAN;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      @"t" <= @"June 30" AND @"t" > @"April 30";

    END
    UUID "{1638ac56-62c7-4b11-be3a-520678573382}";;

    FUNCTION       "CalculateDailyFlow" (  )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      "VolumeToFlow"( "CalculateDailyVolumeToBePumped"(  ), @"t" );

    END
    UUID "{3995a5d5-4d82-4b81-a836-5c74b1f32cd7}";;

    FUNCTION       "CalculateDailyVolumeToBePumped" (  )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "800 acrefeet denotes avg evap in May-June.";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      ( $ "NighthorseData.MaxStorage" [] + 800.00000000 "acre-feet" - $ "Nighthorse Reservoir.Storage" [@"t"] ) / ( $ "NighthorseData.RequestedPumpingPlan" [@"t"] - $ "NighthorseData.RequestedPumpingPlan" [@"t"] / 30.00000000 * $ "NighthorseData.PumpDaysOffPerMonth" [] );

    END
    UUID "{d80929f7-f025-4857-817e-596ffd29dd2d}";;

    FUNCTION       "IsFirstDayOfPumping" (  )
    RETURN_TYPE    BOOLEAN;
    SCALE_UNITS    "";
    DESCRIPTION    "UPDATE THIS to directly pull from input data!";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      $ "NighthorseData.RequestedPumpingPlan" [@"t - 1"] == 0.00000000 AND $ "NighthorseData.RequestedPumpingPlan" [@"t"] > 0.00000000;

    END
    UUID "{4fb70eed-d94a-455a-90e5-4a11337a0895}";;

  END
  UUID "{f4ea95b9-df18-4598-8e7f-473cc9bdc836}";;

  UTILITY_GROUP "Navajo Functions";
  DESCRIPTION   "";
  ACTIVE        TRUE;
  NOTES          "";
  BEGIN

    FUNCTION       "SpringPeakReleaseSeason" (  )
    RETURN_TYPE    BOOLEAN;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      @"t" <= @"July 20" AND @"t" >= @"March 1";

    END
    UUID "{35b7f8be-fe93-4cc4-9b2a-8189675e9c36}";;

    FUNCTION       "SummerBaseflowSeason" (  )
    RETURN_TYPE    BOOLEAN;
    SCALE_UNITS    "";
    DESCRIPTION    "Should be Sptember 30th but trying to avoid spikes.";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      @"t" <= @"September 30" AND @"t" >= @"July 15";

    END
    UUID "{4f3d0b9d-fd0a-4778-bf28-b3819ea5e2b7}";;

    FUNCTION       "OLD SPROperationalSpillVolume" (  )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "374,777 af refers to the volume of the maximum hydrograph minus the base release of 350 cfs over the duration of the maximum SPR.";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      $ "NavajoData.Cycle3AvailableWater" [] - 374777.00000000 "acre-ft";

    END
    UUID "{2ec54b0c-9d84-43a3-bc85-7e9e526f7418}";;

    FUNCTION       "SPROperationalSpillVolume" (  )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "625702 af refers to the volume of the maximum hydrograph (60-days plus ramps) minus the base release of 350 cfs over the duration of the maximum SPR.";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      "Max"( $ "NavajoData.Cycle3AvailableWater" [] - 625702.00000000 "acre-feet", 0.00000000 "acre-ft" );

    END
    UUID "{4513a8f5-c094-403a-9824-e34d69a29f95}";;

    FUNCTION       "VolumeBeyondNose" (  )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "See if there's any extra spill that couldn't be taken care of with SPR Nose.  This is done by taking the maximum release through march 1 (5,000 cfs) and multiplying it by 57 days (first day of SPR is April 27.<br>";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      "OLD SPROperationalSpillVolume"(  ) - 565269.00000000 "acre-ft";

    END
    UUID "{8444ca06-ec4d-4993-9edd-212040e8e372}";;

    FUNCTION       "SpikeSeason" (  )
    RETURN_TYPE    BOOLEAN;
    SCALE_UNITS    "";
    DESCRIPTION    "Use later date (Sept 25-Oct 5) if min, or expecting small spike.<br>Use earlier date (Sept 10-15 start) if max, or expecting large spike.";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
  NAMES_COLOR  "#000000";
    NOTES          "";
    BEGIN

      @"t" <= @"September 30" AND @"t" >= @"September 15";

    END
    UUID "{1d07ec1d-6842-4267-affd-55e4575600f0}";;

    FUNCTION       "FirstAWCalcDate" (  )
    RETURN_TYPE    DATETIME;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      "DateMax"( @"24:00:00 March 1, Current Year", @"Start Timestep" );

    END
    UUID "{d5d629ba-9c98-4959-bc70-6a6f01b40a22}";;

    FUNCTION       "USACEWinterLimitSeason" (  )
    RETURN_TYPE    BOOLEAN;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      @"t" >= @"January 1" AND @"t" <= @"July 15";

    END
    UUID "{e984fb02-ced9-4d8e-abdd-af114c03e287}";;

    FUNCTION       "MinReleaseFunction" (  )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      IF ( $ "Navajo Reservoir.Pool Elevation" [@"t - 1"] <= 6010.00000000 "ft" )
 THEN
  249.00000000 "cfs"
 ELSE
  IF ( $ "Navajo Reservoir.Pool Elevation" [@"t - 1"] > 6060.00000000 "ft" )
  THEN
   349.00000000 "cfs"
  ELSE
   299.00000000 "cfs"
  ENDIF
 ENDIF;

    END
    UUID "{4d80b2e6-e173-474f-acc3-feabdc4b68d9}";;

    FUNCTION       "MinReleaseFunctionbyFcst" (  )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "1=249<br>3=449<br>else = 299";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      IF ( $ "SWITCHES.CBRFC Forecast Type" [] == 1.00000000 )
 THEN
  299.00000000 "cfs"
 ELSE
  IF ( $ "SWITCHES.CBRFC Forecast Type" [] == 3.00000000 )
  THEN
   399.00000000 "cfs"
  ELSE
   299.00000000 "cfs"
  ENDIF
 ENDIF;

    END
    UUID "{52abfcf0-0eb2-4634-909c-91502509e82f}";;

    FUNCTION       "MaxReleaseFunction_SafetyFactor" (  )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      "GetMaxReleaseGivenInflow"( % "Navajo Reservoir", $ "Navajo Reservoir.Inflow" [], @"t" ) * 0.99900000;

    END
    UUID "{79c2c1dd-6a2f-46b6-abc2-26c14c6106b7}";;

    FUNCTION       "OutflowRequredToMeetTPE1" ( OBJECT Res, SLOT ResInflow, SLOT ResStorage, SLOT ResEOYMinStorage )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      IF ( @"t" == @"Finish Timestep" )
 THEN
  ResInflow [@"t - 1"]
 ELSE
  "TargetHWGivenInflow"( Res, @"t", "DateMin"( "NextDate"( @"t", @"September 30" ), @"Finish Timestep" ), "StorageToElevation"( Res, ResEOYMinStorage [] ), "SumFlowsToVolume"( ResInflow, @"t", "DateMin"( "NextDate"( @"t", @"September 30" ), @"Finish Timestep" ) ), ResStorage [@"t - 1"] )
 ENDIF;

    END
    UUID "{dcba1e28-9467-41c7-9711-774564415439}";;

    FUNCTION       "NavajoFloodControlUpperColumnValue" (  )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "acre-ft";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG TRUE;
    NOTES          "";
    BEGIN

      $ "NavajoData.FloodControlTables" [@"t", "Ceiling"( "SumFlowsToVolume"( $ "Navajo Reservoir.Inflow", @"t", @"24:00:00 July 15, Current Year" ), 100000.00000000 "acre-ft" )];

    END
    UUID "{6b705801-2049-49ac-8266-b1a54345a195}";;

    FUNCTION       "NavajoFloodControlLowerColumnValue" (  )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "acre-ft";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG TRUE;
    NOTES          "";
    BEGIN

      $ "NavajoData.FloodControlTables" [@"t", "Floor"( "SumFlowsToVolume"( $ "Navajo Reservoir.Inflow", @"t", @"24:00:00 July 15, Current Year" ), 100000.00000000 "acre-ft" )];

    END
    UUID "{7dd678d7-9917-4212-b7b7-c73fc2c4c82f}";;

  END
  UUID "{10d1ea89-4acb-4ca6-bfd0-b91b846e1aac}";;

  UTILITY_GROUP "Global Functions";
  DESCRIPTION   "";
  ACTIVE        TRUE;
  NAMES_COLOR  "#000000";
  NOTES          "";
  BEGIN

    FUNCTION       "Remaining Spring Runoff Volume" ( OBJECT res )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      IF ( @"t" >= @"March 1" AND @"t" <= @"July 31" )
 THEN
  "SumFlowsToVolume"( res & "Inflow", @"t", @"24:00:00 July 31, Current Year" )
 ELSE
  0.00000000 "acre-feet"
 ENDIF;

    END
    UUID "{00cc1cb1-779c-4770-a282-659a693ff295}";;

    FUNCTION       "CalculateAvailableIrrigationVolume" ( OBJECT Res, SLOT ResInflow, SLOT ResStorage, SLOT ResEOYMinStorage, SLOT ResEvap )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      ( "FlowToVolume"( "OutflowRequredToMeetTPE"( Res, ResInflow, ResStorage, ResEOYMinStorage ), @"t" ) - ResEvap [@"t - 1"] ) * LENGTH @"t" TO "DateMin"( "NextDate"( @"t", @"November 1" ), @"Finish Timestep" );

    END
    UUID "{8e8eb17d-fcf2-4c2d-8e0e-704f364bd4c5}";;

    FUNCTION       "OutflowRequredToMeetTPE" ( OBJECT Res, SLOT ResInflow, SLOT ResStorage, SLOT ResEOYMinStorage )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      IF ( @"t" == @"Finish Timestep" )
 THEN
  ResInflow [@"t - 1"]
 ELSE
  "TargetHWGivenInflow"( Res, @"t", "DateMin"( "NextDate"( @"t", @"November 1" ), @"Finish Timestep" ), "StorageToElevation"( Res, ResEOYMinStorage [] ), "SumFlowsToVolume"( ResInflow, @"t", "DateMin"( "NextDate"( @"t", @"November 1" ), @"Finish Timestep" ) ), ResStorage [@"t - 1"] )
 ENDIF;

    END
    UUID "{c7f2fb94-c3af-4829-8a1d-d67c528eac94}";;

    FUNCTION       "Adjust GainLoss" ( OBJECT Reach )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      FOR ( NUMERIC i IN { 0.00000000 , 1.00000000 , 2.00000000 , 3.00000000 , 4.00000000 , 5.00000000 , 6.00000000 , 7.00000000 , 8.00000000 } ) WITH NUMERIC exceedance = 0.10000000 DO
  IF ( IsNaN Reach & "Inflow" [@"t"] )
  THEN
   0.50000000
  ELSE
   IF ( Reach & "Inflow" [@"t"] > $ "GainLossCalculations.Table" [STRINGIFY Reach, i] )
   THEN
    "Min"( 0.90000000, exceedance + 0.10000000 )
   ELSE
    exceedance
   ENDIF
  ENDIF
 ENDFOR;

    END
    UUID "{b542d8a5-b5f0-40d2-8f77-3d2d1b7b662b}";;

  END
  UUID "{b60c6055-7a6a-4e84-85ec-09095773b47e}";;

  UTILITY_GROUP "Nearest Years";
  DESCRIPTION   "";
  ACTIVE        TRUE;
  NAMES_COLOR  "#ffaa00";
  NOTES          "";
  BEGIN

    FUNCTION       "GetNNearestYears" ( LIST sortedListOfYearsValues, DATETIME month, STRING forecastLocation, STRING forecastType )
    RETURN_TYPE    LIST;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      WITH SLOT CBRFCSlotName = % "CBRFC" & ( "MapForecastLocationToCode"( forecastLocation ) CONCAT forecastType ) DO
  WITH LIST NumSimilarYears = "GetNumbers"( 0.00000000, $ "InflowDisagg.NumberOfSimilarYears" [] - 1.00000000, 1.00000000 ) DO
   IF ( CBRFCSlotName [month] < GET @INDEX 0.00000000 FROM GET @INDEX 0.00000000 FROM sortedListOfYearsValues )
   THEN
    FOR ( NUMERIC index IN NumSimilarYears ) WITH LIST result = {  } DO
     APPEND GET @INDEX 1.00000000 FROM GET @INDEX index FROM sortedListOfYearsValues ONTO result
    ENDFOR COMMENTED_BY "The CBRFC volume is lower than any years in history. Use the lowest N years. <br>"
   ELSE
    FOR ( NUMERIC num IN "GetNumbers"( 0.00000000, ( LENGTH sortedListOfYearsValues ) - 1.00000000, 1.00000000 ) ) WITH LIST result = {  } DO
     IF ( ( GET @INDEX 0.00000000 FROM GET @INDEX num FROM sortedListOfYearsValues ) < CBRFCSlotName [month] AND CBRFCSlotName [month] <= GET @INDEX 0.00000000 FROM GET @INDEX "Min"( num + 1.00000000, ( LENGTH sortedListOfYearsValues ) - 1.00000000 ) FROM sortedListOfYearsValues )
     THEN
      FOR ( NUMERIC index IN NumSimilarYears ) WITH LIST finalResult = {  } DO
       APPEND GET @INDEX 1.00000000 FROM GET @INDEX "Min"( num + index, ( LENGTH sortedListOfYearsValues ) - 1.00000000 ) FROM sortedListOfYearsValues ONTO finalResult
      ENDFOR
     ELSE
      result
     ENDIF
    ENDFOR COMMENTED_BY "The CBRFC volume is in the historical record. Find the year that is lower than the CBRFC volume. <br>Get the two years on either side of this year. <br>"
   ENDIF
   ELSEIF_COND ( CBRFCSlotName [month] > GET @INDEX 0.00000000 FROM GET @INDEX ( LENGTH sortedListOfYearsValues ) - 1.00000000 FROM sortedListOfYearsValues )
   ELSEIF_CLAUSE ( FOR ( NUMERIC index IN NumSimilarYears ) WITH LIST result = {  } DO
    APPEND GET @INDEX 1.00000000 FROM GET @INDEX ( ( LENGTH sortedListOfYearsValues ) - 1.00000000 ) - index FROM sortedListOfYearsValues ONTO result
   ENDFOR COMMENTED_BY "The CBRFC volume is higher than any year in history. Use the highest N years. <br>" )
   END_ELSEIF
  ENDWITH
 ENDWITH;

    END
    UUID "{d6d590d5-38c2-407d-b198-ccf8351d8549}";;

    FUNCTION       "MapForecastLocationToCode" ( STRING forecastLocation )
    RETURN_TYPE    STRING;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      IF ( forecastLocation == "Vallecito" )
 THEN
  "VCRC2"
 ELSE
  "NVRN5"
 ENDIF
 ELSEIF_COND ( forecastLocation == "Lemon" )
 ELSEIF_CLAUSE ( "LEMC2" )
 END_ELSEIF
 ELSEIF_COND ( forecastLocation == "Animas" )
 ELSEIF_CLAUSE ( "DRGC2" )
 END_ELSEIF;

    END
    UUID "{8e35b34b-8791-49fd-9b3c-5955e3c576bc}";;

    FUNCTION       "CBRFC Forecast Type" (  )
    RETURN_TYPE    STRING;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      WITH NUMERIC type = $ "SWITCHES.CBRFC Forecast Type" [] DO
  IF ( type == 2.00000000 )
  THEN
   "most"
  ELSE
   "max" COMMENTED_BY "type == 3 <br>"
  ENDIF
  ELSEIF_COND ( type == 1.00000000 )
  ELSEIF_CLAUSE ( "min" )
  END_ELSEIF
 ENDWITH;

    END
    UUID "{6d08bf44-db73-4045-ab55-f88e43305067}";;

  END
  UUID "{c8184a09-d46b-4f58-a91b-df8b4aff88c5}";;

  UTILITY_GROUP "Loss Functions";
  DESCRIPTION   "";
  ACTIVE        TRUE;
  NAMES_COLOR  "#0000ff";
  NOTES          "";
  BEGIN

    FUNCTION       "Lookup Loss Percentile" ( STRING forecastLocation )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      "TableInterpolation"( $ "GainLossCalculations.ForecastLookupTable", 0.00000000, 1.00000000, "ForecastVolume"( forecastLocation ) / $ "HISTORIC.AverageInflow" [@"t", "GetReservoirFromForecastLocation"( forecastLocation )], @"t" );

    END
    UUID "{78297a92-cf6b-4b42-a07a-3ea3dc467140}";;

    FUNCTION       "ForecastVolume" ( STRING forecastLocation )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      IF ( ( $ "SWITCHES.MODE" [] == 0.00000000 ) COMMENTED_BY "24 Mo Study Mode <br>" )
 THEN
  % "CBRFC" & forecastLocation CONCAT "CBRFC Forecast Type"(  ) [@"24:00:00 Current Month Max DayOfMonth, Current Year"]
 ELSE
  STOP_RUN "No valid mode set"
 ENDIF
 ELSEIF_COND ( ( $ "SWITCHES.MODE" [] == 1.00000000 ) COMMENTED_BY "ESP MRM <br>" )
 ELSEIF_CLAUSE ( "SumFlowsToVolume"( % "MRM Data" & "Trace" CONCAT forecastLocation, @"24:00:00 Current Month Min DayOfMonth, Current Year", @"24:00:00 Current Month Max DayOfMonth, Current Year" ) )
 END_ELSEIF;

    END
    UUID "{1b1f1cc3-36d0-42fe-96f2-74f8fd9facc4}";;

    FUNCTION       "GetReservoirFromForecastLocation" ( STRING forecastLocation )
    RETURN_TYPE    STRING;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      IF ( forecastLocation == "VCRC2" )
 THEN
  "Vallecito Reservoir"
 ELSE
  STOP_RUN "Unexpected forecast location"
 ENDIF
 ELSEIF_COND ( forecastLocation == "LEMC2" )
 ELSEIF_CLAUSE ( "Lemon Reservoir" )
 END_ELSEIF
 ELSEIF_COND ( forecastLocation == "DRGC2" )
 ELSEIF_CLAUSE ( "Animas" )
 END_ELSEIF
 ELSEIF_COND ( forecastLocation == "NVRN5" )
 ELSEIF_CLAUSE ( "Navajo Reservoir" )
 END_ELSEIF;

    END
    UUID "{3c5be26b-827d-4044-b224-e4c6bb1b644e}";;

  END
  UUID "{5a8a2639-6c1b-4026-b015-7630098667f0}";;

END
UUID "{758a3ded-5c67-4684-b553-4e52f6fba6ba}";
